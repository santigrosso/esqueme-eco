<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Esquema de lesi√≥n muscular ‚Äî v2.1 (herramientas + color + l√≠nea)</title>
<style>
  :root{
    --bg:#0f1115; --ink:#0e1320; --muted:#6b7890; --accent:#5B7EAE; --accent-weak:#8fa7c7;
    --panel:#ffffff; --line:#e7ecf3; --overlay:rgba(24,30,44,.85);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:#fff}
  .app{min-height:100dvh;display:grid;grid-template-rows:auto auto 1fr auto}

  /* Header */
  header{padding:1rem 1.25rem;border-bottom:1px solid rgba(255,255,255,.1);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,0))}
  header h1{margin:0;font-size:1.35rem;letter-spacing:.2px}

  /* Panel de datos */
  .panel-datos{background:var(--panel);color:var(--ink);padding:1rem 1.25rem;border-bottom:1px solid var(--line);display:flex;flex-wrap:wrap;align-items:end;gap:.8rem;overflow-x:visible}
  .panel-datos .fld{min-width:220px}
  .panel-datos .actions{min-width:max-content;display:flex;gap:.5rem;margin-left:auto}
  .fld{display:flex;flex-direction:column;gap:.35rem}
  .fld label{font-size:.85rem;color:#53607a}
  .fld input{padding:.6rem .7rem;border:1px solid var(--line);border-radius:.6rem}
  .btn{appearance:none;border:none;border-radius:.6rem;padding:.65rem 1rem;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--accent);color:#0d1117}
  .btn.ghost{background:transparent;border:1px solid var(--accent-weak);color:#1b2435}

  /* Panel SVG + Tabs */
  .svg-panel{background:var(--panel);color:var(--ink);padding:0 1.25rem 1rem 1.25rem;border-bottom:1px solid var(--line)}
  .toolbar{display:flex;gap:1rem;align-items:center;justify-content:space-between;padding:.6rem 0 .2rem 0;color:#1b2435;position:relative;z-index:10}
  .tabs{display:flex;gap:.25rem;flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:thin;padding-top:.6rem;position:relative;z-index:2;background:#fff;border-bottom:1px solid var(--line)}
  .tab{appearance:none;border:1px solid var(--line);background:#f6f8fb;color:#1b2435;padding:.55rem .9rem;border-top-left-radius:.75rem;border-top-right-radius:.75rem;cursor:pointer;font-weight:700;flex:0 0 auto;-webkit-tap-highlight-color: rgba(0,0,0,0);} 
  .tab.active{background:#fff;border-bottom-color:transparent;box-shadow:0 -6px 24px rgba(0,0,0,.12)}
  .canvas{border:1px solid var(--line);border-top:none;border-radius:0 0 .9rem .9rem;overflow:hidden;background:#1c1f25;position:relative;z-index:1}
  .canvas svg{display:block;width:100%;height:auto;touch-action:none}

  /* Estilos de marcas */
  .pin{fill:#FFD54F;stroke:#b79c3b;stroke-width:1.2;pointer-events:auto;cursor:pointer}
  .free{fill:none;stroke:#FFD54F;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;pointer-events:auto;cursor:pointer}
  .line{fill:none;stroke:#FFD54F;stroke-width:2;stroke-linecap:round;pointer-events:auto;cursor:pointer}
  #placeholder text{user-select:none}
  #phMsg{fill:#c7d6eb;font-size:18px}

  /* Herramientas (vertical, superpuesta, oculta por defecto) */
  .tools-toggle{position:absolute;left:10px;top:10px;z-index:5}
  .tools-toggle .tbtn{width:38px;height:38px;border-radius:10px;border:1px solid #95a6c1;background:#eaf0f8;color:#132033;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
  .tools-panel{position:absolute;left:10px;top:58px;width:48px;border-radius:12px;padding:8px;background:var(--overlay);backdrop-filter:blur(6px);border:1px solid rgba(149,166,193,.45);display:none;z-index:6}
  .tools-panel.open{display:block}
  .tool{width:32px;height:32px;border-radius:8px;border:1px solid rgba(231,236,243,.25);background:transparent;color:#e8eef7;display:flex;align-items:center;justify-content:center;cursor:pointer;margin:6px 0;position:relative}
  .tool.active{background:rgba(231,236,243,.15);border-color:#e7ecf3}
  .tool svg{width:18px;height:18px}

  /* Swatches de color */
  .palette{position:absolute;left:56px;top:0;display:none;gap:6px;flex-wrap:wrap;width:132px;background:var(--overlay);border:1px solid rgba(149,166,193,.45);padding:8px;border-radius:10px}
  .palette.open{display:flex}
  .sw{width:22px;height:22px;border-radius:6px;border:1px solid rgba(255,255,255,.6);cursor:pointer}
  .sw.active{outline:2px solid #fff}
  .color-chip{width:14px;height:14px;border-radius:3px;border:1px solid rgba(0,0,0,.25);display:block}

  /* Panel caracter√≠sticas (3 columnas fijas) */
  .caract{background:var(--panel);color:var(--ink);padding:1rem 1.25rem 1.25rem;border-top:1px solid var(--line)}
  .caract h2{margin:.2rem 0 1rem 0;font-size:1.05rem}
  .cards{display:grid;grid-template-columns:repeat(3,minmax(260px,1fr));gap:1rem;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:thin}
  .card{border:1px solid var(--line);border-radius:.9rem;background:#fff;padding:.9rem}
  .card h3{margin:.1rem 0 .6rem 0;font-size:.95rem;color:#1b2435}
  .opt{display:grid;gap:.45rem}
  .opt label{display:flex;align-items:center;gap:.5rem}

  footer{padding:.8rem 1.25rem;color:#97a6bf;font-size:.9rem;border-top:1px solid rgba(255,255,255,.1)}

  /* Impresi√≥n A4 */
  @media print{
    @page{size:A4;margin:12mm 10mm 14mm 10mm}
    body{background:#fff;color:#000}
    header{color:#000;border-bottom:1px solid #ddd}
    .btn,.tools-toggle,.tools-panel,.palette{display:none!important}
    footer{color:#333;border-top:1px solid #ddd}
  }
</style>
</head>
<body>
<div class="app">
  <!-- HEADER -->
  <header><h1>Esquema de lesi√≥n muscular</h1></header>

  <!-- PANEL DE DATOS -->
  <section class="panel-datos">
    <div class="fld"><label>Nombre y Apellido</label><input id="inpNombre" placeholder="Apellido, Nombre"/></div>
    <div class="fld"><label>Fecha de lesi√≥n</label><input id="inpFecha" type="date"/></div>
    <div class="actions"><button class="btn primary" id="btnPDF">Generar PDF</button></div>
  </section>

  <!-- PANEL SVG + TABS -->
  <section class="svg-panel">
    <div class="toolbar">
      <div style="display:flex;gap:1rem;align-items:center;flex-wrap:wrap">
        <div id="sideToggle" style="display:inline-flex;border:1px solid #b9c6d9;border-radius:.6rem;overflow:hidden">
          <button type="button" class="seg seg-left active" data-side="derecho" style="padding:.45rem .75rem;border:0;background:#e8eef7;color:#0e1320;font-weight:700">D</button>
          <button type="button" class="seg seg-right" data-side="izquierdo" style="padding:.45rem .75rem;border:0;background:#f6f8fb;color:#0e1320;font-weight:700;border-left:1px solid #b9c6d9">I</button>
        </div>
        <label id="markSwitch" style="display:none"> <!-- oculto, mantenido por compatibilidad -->
          <input id="toggleMark" type="checkbox" aria-label="Activar marcas">
          <span class="track" aria-hidden="true"></span>
          <span class="thumb" aria-hidden="true"></span>
          <span class="label">Activar marcas (‚òÖ)</span>
        </label>
        <button class="btn ghost" id="btnClearPins" title="Eliminar todas las estrellas">Limpiar estrellas</button>
      </div>
    </div>
    <div class="tabs" id="tabs">
      <button class="tab" data-musculo="biceps">B√≠ceps femoral</button>
      <button class="tab" data-musculo="semis">Semitendinoso/Semimembranoso</button>
      <button class="tab active" data-musculo="rac">Recto anterior del cu√°driceps</button>
      <button class="tab" data-musculo="aductores">Aductores</button>
      <button class="tab" data-musculo="gemelos">Gemelos</button>
      <button class="tab" data-musculo="soleo">S√≥leo</button>
    </div>
    <div class="canvas">
      <!-- Toggle herramientas -->
      <div class="tools-toggle"><button id="btnTools" class="tbtn" title="Herramientas" aria-label="Herramientas">üß∞</button></div>
      <!-- Panel herramientas -->
      <div id="tools" class="tools-panel" aria-hidden="true">
        <button class="tool" data-tool="star" title="Estrella" aria-label="Estrella">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3l2.9 5.9 6.5.9-4.7 4.6 1.1 6.5L12 18.9 6.2 21l1.1-6.5L2.6 9.8l6.5-.9L12 3z"/></svg>
        </button>
        <button class="tool" data-tool="free" title="Dibujo libre" aria-label="Dibujo libre">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 15c2-2 4-2 6 0s4 2 6 0 4-2 6 0"/></svg>
        </button>
        <button class="tool" data-tool="line" title="L√≠nea" aria-label="L√≠nea">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 20 L20 4"/></svg>
        </button>
        <button class="tool" data-tool="color" title="Color" aria-label="Color">
          <span class="color-chip" id="colorChip"></span>
        </button>
        <div id="palette" class="palette" aria-hidden="true">
          <button class="sw" data-color="#FFD54F" style="background:#FFD54F"></button>
          <button class="sw" data-color="#FF6B6B" style="background:#FF6B6B"></button>
          <button class="sw" data-color="#4DD0E1" style="background:#4DD0E1"></button>
          <button class="sw" data-color="#81C784" style="background:#81C784"></button>
          <button class="sw" data-color="#BA68C8" style="background:#BA68C8"></button>
          <button class="sw" data-color="#FFFFFF" style="background:#FFFFFF"></button>
        </div>
        <button class="tool" data-tool="erase" title="Borrar" aria-label="Borrar">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 3l5 5-9 9H7L2 12l9-9h5zM7 17h10v2H7z"/></svg>
        </button>
        <button class="tool" data-tool="undo" title="Deshacer" aria-label="Deshacer">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 14L4 9l5-5"/><path d="M20 20a8 8 0 0 0-8-8H4"/></svg>
        </button>
        <button class="tool" data-tool="redo" title="Rehacer" aria-label="Rehacer">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14l5-5-5-5"/><path d="M4 20a8 8 0 0 1 8-8h8"/></svg>
        </button>
      </div>

      <svg id="panelSVG" viewBox="0 0 1600 900" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
        <rect x="0" y="0" width="1600" height="900" fill="#1c1f25"/>
        <g id="artwork"></g>
        <g id="pins"></g>
        <g id="free"></g>
        <g id="lines"></g>
        <g id="placeholder">
          <rect x="80" y="80" width="1440" height="740" fill="#222832" stroke="#3a4250"/>
          <text x="800" y="430" fill="#8fa7c7" font-size="42" text-anchor="middle" font-family="system-ui, -apple-system">Pegaremos aqu√≠ el SVG de <tspan id="tMusculo">RAC</tspan> ‚Äî <tspan id="tLado">derecho</tspan></text>
          <text id="phMsg" x="800" y="490" text-anchor="middle" font-family="system-ui, -apple-system">Sub√≠ el archivo faltante a ./svg/<tspan id="phMus">rac</tspan>/<tspan id="phFile">rac-derecho.svg</tspan></text>
        </g>
      </svg>
    </div>
  </section>

  <!-- PANEL CARACTER√çSTICAS -->
  <section class="caract">
    <h2>Caracter√≠sticas de la lesi√≥n</h2>
    <div class="cards">
      <div class="card">
        <h3>Grado</h3>
        <div class="opt" id="optGrado">
          <label><input type="radio" name="grado" value="1"> Grado 1 (a,b)</label>
          <label><input type="radio" name="grado" value="2"> Grado 2 (a,b,c)</label>
          <label><input type="radio" name="grado" value="3"> Grado 3 (a,b,c)</label>
          <label><input type="radio" name="grado" value="4"> Grado 4 (c)</label>
        </div>
      </div>
      <div class="card">
        <h3>Tejido afectado</h3>
        <div class="opt" id="optTejido">
          <label><input type="checkbox" value="miofascial"> Miofascial (a)</label>
          <label><input type="checkbox" value="miotendinoso"> Miotendinoso (b)</label>
          <label><input type="checkbox" value="tendinoso"> Tendinoso (c)</label>
          <label><input type="checkbox" value="intramuscular"> Intramuscular</label>
        </div>
      </div>
      <div class="card">
        <h3>Lesiones asociadas</h3>
        <div class="opt" id="optAsociadas">
          <label><input type="checkbox" value="lamina"> L√°mina l√≠quida</label>
          <label><input type="checkbox" value="coleccion"> Colecci√≥n</label>
          <label><input type="checkbox" value="cicatriz"> Cicatriz fibrosa</label>
          <label><input type="checkbox" value="calcificaciones"> Calcificaciones</label>
          <label><input type="checkbox" value="recidiva"> Recidiva</label>
        </div>
      </div>
    </div>
  </section>

  <footer>Desarrollado por Santiago Grosso</footer>
</div>

<script>
(function(){
  // ===== Config =====
  var BASE_SVG_PATH = './svg'; // ./svg/<musculo>/<musculo>-<lado>.svg
  var $ = function(s){ return document.querySelector(s); };
  var $$ = function(s){ return Array.prototype.slice.call(document.querySelectorAll(s)); };
  var musculo = 'rac';
  var lado = 'derecho';

  // Estado de herramientas
  var currentTool = null; // 'star' | 'free' | 'line' | 'erase' | null
  var currentColor = '#FFD54F';

  // Undo/Redo (simple)
  var undoStack = []; // {type:'add'|'remove', el:Node, parent:Node, nextSibling:Node|null}
  var redoStack = [];
  function pushAdd(el){ undoStack.push({type:'add', el:el, parent:el.parentNode, nextSibling:el.nextSibling}); redoStack.length=0; }
  function pushRemove(el,parent,next){ undoStack.push({type:'remove', el:el, parent:parent, nextSibling:next}); redoStack.length=0; }
  function cmdUndo(){ var op=undoStack.pop(); if(!op) return; if(op.type==='add'){ var p=op.parent; var e=op.el; if(e && e.parentNode){ var ns=e.nextSibling; p.removeChild(e); redoStack.push({type:'remove', el:e, parent:p, nextSibling:ns}); } }
    else if(op.type==='remove'){ if(op.parent){ op.parent.insertBefore(op.el, op.nextSibling||null); redoStack.push({type:'add', el:op.el, parent:op.parent, nextSibling:op.nextSibling}); } } }
  function cmdRedo(){ var op=redoStack.pop(); if(!op) return; if(op.type==='add'){ if(op.parent){ op.parent.insertBefore(op.el, op.nextSibling||null); undoStack.push({type:'add', el:op.el, parent:op.parent, nextSibling:op.nextSibling}); } }
    else if(op.type==='remove'){ var e=op.el; var p=e && e.parentNode; if(p){ var ns=e.nextSibling; p.removeChild(e); undoStack.push({type:'remove', el:e, parent:p, nextSibling:ns}); } } }

  // Utilidades de color
  function darken(hex, amt){
    var h = hex.replace('#',''); if(h.length===3){ h=h[0]+h[0]+h[1]+h[1]+h[2]+h[2]; }
    var r=parseInt(h.substr(0,2),16), g=parseInt(h.substr(2,2),16), b=parseInt(h.substr(4,2),16);
    r=Math.max(0, Math.min(255, r - Math.round(255*amt)));
    g=Math.max(0, Math.min(255, g - Math.round(255*amt)));
    b=Math.max(0, Math.min(255, b - Math.round(255*amt)));
    var toHex=function(n){ var s=n.toString(16); return s.length===1?'0'+s:s; };
    return '#'+toHex(r)+toHex(g)+toHex(b);
  }
  function applyColorChip(){ var chip=$('#colorChip'); if(chip){ chip.style.background = currentColor; chip.style.borderColor = darken(currentColor, .35); } }

  // DOM refs
  var panelSVG = document.getElementById('panelSVG');
  var artwork  = document.getElementById('artwork');
  var pins     = document.getElementById('pins');
  var freeGrp  = document.getElementById('free');
  var linesGrp = document.getElementById('lines');
  var ph       = document.getElementById('placeholder');
  var phMus    = document.getElementById('phMus');
  var phFile   = document.getElementById('phFile');
  var tMus     = document.getElementById('tMusculo');
  var tLado    = document.getElementById('tLado');

  // ===== Carga de SVG =====
  function loadSVG(){
    if(!artwork) return Promise.resolve();
    var path = BASE_SVG_PATH + '/' + musculo + '/' + musculo + '-' + lado + '.svg';
    if(phMus)  phMus.textContent  = musculo;
    if(phFile) phFile.textContent = musculo + '-' + lado + '.svg';
    if(tMus){ var tabEl = document.querySelector('.tab[data-musculo="' + musculo + '"]'); tMus.textContent = (tabEl ? tabEl.textContent : musculo).trim(); }
    if(tLado)  tLado.textContent  = lado;

    return fetch(path,{cache:'no-store'}).then(function(res){
      if(!res.ok){ if(ph) ph.style.display='block'; artwork.innerHTML=''; console.warn('[SVG] No encontrado:', path); return null; }
      return res.text();
    }).then(function(txt){
      if(txt===null) return;
      var doc = new DOMParser().parseFromString(txt,'image/svg+xml');
      var src = doc.querySelector('svg');
      if(!src){ if(ph) ph.style.display='block'; artwork.innerHTML=''; console.warn('[SVG] Sin <svg> ra√≠z:', path); return; }
      artwork.innerHTML='';
      var vb = src.getAttribute('viewBox'); panelSVG.setAttribute('viewBox', vb ? vb : '0 0 1600 900');
      Array.prototype.slice.call(src.childNodes).forEach(function(n){ artwork.appendChild(panelSVG.ownerDocument.importNode(n,true)); });
      if(ph) ph.style.display='none';
    }).catch(function(err){ if(ph) ph.style.display='block'; artwork.innerHTML=''; console.warn('[SVG] Error al cargar', path, (err && err.message) || err); });
  }

  // ===== Marcas: estrella, dibujo libre (rellenable) y l√≠nea =====
  function clearPins(){ if(pins){ while(pins.firstChild) pins.removeChild(pins.firstChild); } }
  function clearFree(){ var arr=document.querySelectorAll('#free path'); for(var i=0;i<arr.length;i++){ var p=arr[i]; p.parentNode.removeChild(p);} }
  function clearLines(){ var arr=document.querySelectorAll('#lines line'); for(var i=0;i<arr.length;i++){ var p=arr[i]; p.parentNode.removeChild(p);} }

  var STAR_MIN = 10, STAR_MAX = 56;
  var svgPoint = function(svg, clientX, clientY){ var pt = svg.createSVGPoint(); pt.x=clientX; pt.y=clientY; return pt.matrixTransform(svg.getScreenCTM().inverse()); };
  var starPath = function(cx,cy,r,spikes){ if(spikes==null) spikes=5; var inner=r*0.48; var rot=Math.PI/2*3, x=cx, y=cy, step=Math.PI/spikes, d='M ' + cx + ' ' + (cy-r);
    for(var i=0;i<spikes;i++){ x=cx+Math.cos(rot)*r; y=cy+Math.sin(rot)*r; d+=' L ' + x + ' ' + y; rot+=step; x=cx+Math.cos(rot)*inner; y=cy+Math.sin(rot)*inner; d+=' L ' + x + ' ' + y; rot+=step; } return d+' Z'; };

  var drawing=null, start=null;        // para estrella
  var freePath=null, freeD='', freeStart=null; // para libre con cierre
  var lineEl=null, lineStart=null;     // para l√≠nea

  function startStar(e){ var p=svgPoint(panelSVG, e.clientX, e.clientY); start=p; var path=document.createElementNS('http://www.w3.org/2000/svg','path'); path.setAttribute('class','pin'); path.setAttribute('fill', currentColor); path.setAttribute('stroke', darken(currentColor,.3)); path.setAttribute('stroke-width','1.2'); path.setAttribute('d', starPath(p.x,p.y,STAR_MIN)); pins.appendChild(path); drawing=path; pushAdd(path); }
  function updateStar(e){ if(!drawing) return; var p=svgPoint(panelSVG, e.clientX, e.clientY); var dx=p.x-start.x, dy=p.y-start.y; var r=Math.max(STAR_MIN, Math.min(STAR_MAX, Math.hypot(dx,dy))); drawing.setAttribute('d', starPath(start.x,start.y,r)); }
  function endStar(){ drawing=null; start=null; }

  function startFree(e){ var p=svgPoint(panelSVG, e.clientX, e.clientY); freeStart=p; freeD='M '+p.x+' '+p.y; freePath=document.createElementNS('http://www.w3.org/2000/svg','path'); freePath.setAttribute('class','free'); freePath.setAttribute('stroke', darken(currentColor,.25)); freePath.setAttribute('stroke-width','2'); freePath.setAttribute('fill','none'); freePath.setAttribute('d', freeD); freeGrp.appendChild(freePath); pushAdd(freePath); }
  function updateFree(e){ if(!freePath) return; var p=svgPoint(panelSVG, e.clientX, e.clientY); freeD += ' L '+p.x+' '+p.y; freePath.setAttribute('d', freeD); }
  function endFree(e){ if(!freePath) return; // si cierra cerca del inicio, cerrar y rellenar
    var p=svgPoint(panelSVG, e.clientX, e.clientY); var dist=Math.hypot(p.x-freeStart.x, p.y-freeStart.y);
    if(dist<20 && freeD.split('L').length>6){ // umbral y puntos m√≠nimos
      freeD += ' Z'; freePath.setAttribute('d', freeD); freePath.setAttribute('fill', currentColor); freePath.setAttribute('stroke', darken(currentColor,.35));
    }
    freePath=null; freeD=''; freeStart=null; }

  function startLine(e){ var p=svgPoint(panelSVG, e.clientX, e.clientY); lineStart=p; lineEl=document.createElementNS('http://www.w3.org/2000/svg','line'); lineEl.setAttribute('class','line'); lineEl.setAttribute('x1', p.x); lineEl.setAttribute('y1', p.y); lineEl.setAttribute('x2', p.x); lineEl.setAttribute('y2', p.y); lineEl.setAttribute('stroke', darken(currentColor,.25)); lineEl.setAttribute('stroke-width','2'); linesGrp.appendChild(lineEl); pushAdd(lineEl); }
  function updateLine(e){ if(!lineEl) return; var p=svgPoint(panelSVG, e.clientX, e.clientY); lineEl.setAttribute('x2', p.x); lineEl.setAttribute('y2', p.y); }
  function endLine(e){ if(!lineEl) return; var p=svgPoint(panelSVG, e.clientX, e.clientY); var len=Math.hypot(p.x-lineStart.x, p.y-lineStart.y); if(len<6){ var parent=lineEl.parentNode; var next=lineEl.nextSibling; parent.removeChild(lineEl); undoStack.pop(); } lineEl=null; lineStart=null; }

  function tryErase(target){ if(!target) return; if(target.classList && (target.classList.contains('pin') || target.classList.contains('free') || target.classList.contains('line'))){ var parent=target.parentNode; var next=target.nextSibling; parent.removeChild(target); pushRemove(target,parent,next); } }

  // Interacci√≥n principal
  function onPointerDown(e){ if(!panelSVG || e.button===2) return; var t=e.target; if(currentTool==='erase'){ tryErase(t); return; }
    if(t && t.classList && (t.classList.contains('pin')||t.classList.contains('free')||t.classList.contains('line'))){ tryErase(t); return; }
    if(currentTool==='star'){ e.preventDefault&&e.preventDefault(); startStar(e); }
    else if(currentTool==='free'){ e.preventDefault&&e.preventDefault(); startFree(e); }
    else if(currentTool==='line'){ e.preventDefault&&e.preventDefault(); startLine(e); }
  }
  function onPointerMove(e){ if(currentTool==='star'){ updateStar(e); } else if(currentTool==='free'){ updateFree(e); } else if(currentTool==='line'){ updateLine(e); } }
  function onPointerEnd(e){ if(currentTool==='star'){ endStar(); } else if(currentTool==='free'){ endFree(e); } else if(currentTool==='line'){ endLine(e); } }

  if(panelSVG){ panelSVG.addEventListener('pointerdown', onPointerDown, {passive:false}); window.addEventListener('pointermove', onPointerMove, {passive:false}); window.addEventListener('pointerup', onPointerEnd, {passive:false}); window.addEventListener('pointercancel', onPointerEnd, {passive:false}); }

  // ===== UI: Herramientas y paleta =====
  var btnTools = document.getElementById('btnTools');
  var toolsPanel = document.getElementById('tools');
  var palette = document.getElementById('palette');
  var colorChip = document.getElementById('colorChip');
  function setTool(name){ currentTool=name; $$('#tools .tool').forEach(function(b){ b.classList.toggle('active', b.getAttribute('data-tool')===name); }); if(name!=='color' && palette){ palette.classList.remove('open'); palette.setAttribute('aria-hidden','true'); } }
  if(btnTools){ btnTools.addEventListener('click', function(){ var open = toolsPanel.classList.toggle('open'); toolsPanel.setAttribute('aria-hidden', open? 'false':'true'); }); }
  if(toolsPanel){ toolsPanel.addEventListener('click', function(ev){ var btn = ev.target.closest ? ev.target.closest('.tool') : null; if(!btn) return; var tool = btn.getAttribute('data-tool'); if(tool==='color'){ if(palette){ var open=palette.classList.toggle('open'); palette.setAttribute('aria-hidden', open? 'false':'true'); } return; } if(tool==='undo'){ cmdUndo(); return; } if(tool==='redo'){ cmdRedo(); return; } setTool(tool); }); }
  if(palette){ palette.addEventListener('click', function(ev){ var sw = ev.target.closest ? ev.target.closest('.sw') : null; if(!sw) return; currentColor = sw.getAttribute('data-color'); applyColorChip(); // destacar sw
      $$('#palette .sw').forEach(function(s){ s.classList.toggle('active', s===sw); }); }); }

  // ===== Botoner√≠a previa =====
  var btnClearPins = document.getElementById('btnClearPins'); if(btnClearPins) btnClearPins.addEventListener('click', function(){ clearPins(); clearFree(); clearLines(); });

  // Tabs
  var tabsEl = document.getElementById('tabs'); if(tabsEl){ tabsEl.addEventListener('click', function(e){ var t = e.target && e.target.closest ? e.target.closest('.tab') : null; if(!t) return; $$('#tabs .tab').forEach(function(o){ o.classList.remove('active'); }); t.classList.add('active'); musculo = t.getAttribute('data-musculo'); clearPins(); clearFree(); clearLines(); loadSVG(); }); }

  // Lado
  var sideToggle = document.getElementById('sideToggle'); if(sideToggle){ sideToggle.addEventListener('click', function(ev){ var btn = ev.target && ev.target.closest ? ev.target.closest('button[data-side]') : null; if(!btn) return; Array.prototype.slice.call(sideToggle.querySelectorAll('button[data-side]')).forEach(function(b){ b.classList.remove('active'); }); btn.classList.add('active'); lado = btn.getAttribute('data-side'); clearPins(); clearFree(); clearLines(); loadSVG(); }); }

  // Botones generales
  var btnPDF    = document.getElementById('btnPDF');    if(btnPDF)    btnPDF.addEventListener('click', function(){ window.print(); });

  // ===== TESTS =====
  function assert(cond,msg){ if(!cond){ console.error('[TEST FAIL]',msg); return false;} console.log('[TEST OK]',msg); return true; }
  var tests=[
    function(){ return assert(!!document.getElementById('tabs'),'Existe barra de tabs'); },
    function(){ return assert(document.querySelectorAll('#tabs .tab').length===6,'Hay 6 pesta√±as'); },
    function(){ return assert(!!document.getElementById('sideToggle'),'Selector I/D presente'); },
    function(){ return assert(!!document.getElementById('panelSVG'),'Existe panel SVG'); },
    function(){ return assert(typeof loadSVG==='function','loadSVG definida'); },
    function(){ try{ var p=loadSVG(); return assert(p instanceof Promise || p===undefined,'loadSVG no arroja'); }catch(e){ return assert(false,'loadSVG no deber√≠a arrojar'); } },
    function(){ return assert(!!document.getElementById('btnTools'),'Bot√≥n Herramientas presente'); },
    function(){ // abrir/cerrar panel
      var btn=document.getElementById('btnTools'); var panel=document.getElementById('tools'); var before=panel.classList.contains('open'); btn.click(); var after=panel.classList.contains('open'); return assert(after!==before,'Toggle abre/cierra panel de herramientas'); },
    function(){ // paleta abre y cambia color
      var colorBtn=document.querySelector('.tool[data-tool="color"]'); colorBtn.click(); var pal=document.getElementById('palette'); var open=pal.classList.contains('open'); var sw=document.querySelector('#palette .sw'); if(!open||!sw) return assert(false,'Paleta no abre'); var prev=window.getComputedStyle(document.getElementById('colorChip')).backgroundColor; sw.click(); applyColorChip(); var now=window.getComputedStyle(document.getElementById('colorChip')).backgroundColor; return assert(prev!==now,'Cambio de color activo'); },
    function(){ // estrella crea
      currentTool='star'; var before=pins.childElementCount; var rect=panelSVG.getBoundingClientRect(); try{ var down=new PointerEvent('pointerdown',{clientX:rect.left+90,clientY:rect.top+90}); var move=new PointerEvent('pointermove',{clientX:rect.left+120,clientY:rect.top+120}); var up=new PointerEvent('pointerup',{clientX:rect.left+120,clientY:rect.top+120}); panelSVG.dispatchEvent(down); window.dispatchEvent(move); window.dispatchEvent(up);}catch(_){ } var after=pins.childElementCount; return assert(after===before+1,'Estrella creada'); },
    function(){ // libre con cierre
      currentTool='free'; var before=freeGrp.childElementCount; var rect=panelSVG.getBoundingClientRect(); try{ var d=new PointerEvent('pointerdown',{clientX:rect.left+300,clientY:rect.top+300}); var m1=new PointerEvent('pointermove',{clientX:rect.left+340,clientY:rect.top+300}); var m2=new PointerEvent('pointermove',{clientX:rect.left+340,clientY:rect.top+340}); var m3=new PointerEvent('pointermove',{clientX:rect.left+300,clientY:rect.top+340}); var m4=new PointerEvent('pointermove',{clientX:rect.left+300,clientY:rect.top+302}); var u=new PointerEvent('pointerup',{clientX:rect.left+300,clientY:rect.top+302}); panelSVG.dispatchEvent(d); window.dispatchEvent(m1); window.dispatchEvent(m2); window.dispatchEvent(m3); window.dispatchEvent(m4); window.dispatchEvent(u);}catch(_){ } var after=freeGrp.childElementCount; var ok = after===before+1; return assert(ok,'Dibujo libre cerrado y rellenado'); },
    function(){ // l√≠nea
      currentTool='line'; var before=linesGrp.childElementCount; var rect=panelSVG.getBoundingClientRect(); try{ var d=new PointerEvent('pointerdown',{clientX:rect.left+400,clientY:rect.top+200}); var m=new PointerEvent('pointermove',{clientX:rect.left+460,clientY:rect.top+260}); var u=new PointerEvent('pointerup',{clientX:rect.left+460,clientY:rect.top+260}); panelSVG.dispatchEvent(d); window.dispatchEvent(m); window.dispatchEvent(u);}catch(_){ } var after=linesGrp.childElementCount; return assert(after===before+1,'L√≠nea creada'); }
  ];
  tests.forEach(function(t){ try{ t(); }catch(e){ console.error('[TEST ERROR]', e); } });

  // Limpieza visual tras tests
  try{ clearPins(); clearFree(); clearLines(); }catch(_){ }

  // Carga inicial y estado inicial
  loadSVG();
  applyColorChip();
  setTool(null);
})();
</script>
</body>
</html>
