<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Esquema de lesión muscular — Wireframe v1 (fix CSP + tests)</title>
<style>
  :root{
    --bg:#0f1115; --ink:#0e1320; --muted:#6b7890; --accent:#5B7EAE; --accent-weak:#8fa7c7;
    --panel:#ffffff; --line:#e7ecf3; --chip:#f3f6fa; --chip-br:#dfe7f1;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:#fff}
  .app{min-height:100dvh;display:grid;grid-template-rows:auto auto 1fr auto}

  /* Header */
  header{padding:1rem 1.25rem;border-bottom:1px solid rgba(255,255,255,.1);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,0))}
  header h1{margin:0;font-size:1.35rem;letter-spacing:.2px}

  /* Panel de datos (fila scrolleable en mobile) */
  .panel-datos{background:var(--panel);color:var(--ink);padding:1rem 1.25rem;border-bottom:1px solid var(--line);display:flex;flex-wrap:nowrap;align-items:end;gap:.8rem;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:thin}
  .panel-datos .fld{min-width:220px}
  .panel-datos .actions{min-width:max-content;display:flex;gap:.5rem;margin-left:auto}
  .fld{display:flex;flex-direction:column;gap:.35rem}
  .fld label{font-size:.85rem;color:#53607a}
  .fld input,.fld select{padding:.6rem .7rem;border:1px solid var(--line);border-radius:.6rem}
  .btn{appearance:none;border:none;border-radius:.6rem;padding:.65rem 1rem;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--accent);color:#0d1117}
  .btn.ghost{background:transparent;border:1px solid var(--accent-weak);color:#1b2435}

  /* Panel SVG + Tabs */
  .svg-panel{background:var(--panel);color:var(--ink);padding:0 1.25rem 1rem 1.25rem;border-bottom:1px solid var(--line)}
  .tabs{display:flex;gap:.25rem;flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:thin;padding-top:.6rem;position:relative;z-index:2;background:#fff;border-bottom:1px solid var(--line)}
  .tab{appearance:none;border:1px solid var(--line);background:#f6f8fb;color:#1b2435;padding:.55rem .9rem;border-top-left-radius:.75rem;border-top-right-radius:.75rem;cursor:pointer;font-weight:700;flex:0 0 auto;-webkit-tap-highlight-color: rgba(0,0,0,0);}
  .tab.active{background:#fff;border-bottom-color:transparent;box-shadow:0 -6px 24px rgba(0,0,0,.12)}
  .canvas{border:1px solid var(--line);border-top:none;border-radius:0 0 .9rem .9rem;overflow:hidden;background:#1c1f25;position:relative;z-index:1}
  .canvas svg{display:block;width:100%;height:auto;touch-action:none}
  .pin{fill:#FFD54F;stroke:#ffffff;stroke-width:1.5;pointer-events:auto;cursor:pointer}
  .grab{cursor:grab}
  .grabbing{cursor:grabbing}
  #placeholder text{user-select:none}
  #phMsg{fill:#c7d6eb;font-size:18px}

  /* Panel características (siempre 3 columnas) */
  .caract{background:var(--panel);color:var(--ink);padding:1rem 1.25rem 1.25rem;border-top:1px solid var(--line)}
  .caract h2{margin:.2rem 0 1rem 0;font-size:1.05rem}
  .cards{display:grid;grid-template-columns:repeat(3,minmax(260px,1fr));gap:1rem;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:thin}
  .card{border:1px solid var(--line);border-radius:.9rem;background:#fff;padding:.9rem}
  .card h3{margin:.1rem 0 .6rem 0;font-size:.95rem;color:#1b2435}
  .opt{display:grid;gap:.45rem}
  .opt label{display:flex;align-items:center;gap:.5rem}

  footer{padding:.8rem 1.25rem;color:#97a6bf;font-size:.9rem;border-top:1px solid rgba(255,255,255,.1)}

  /* Impresión A4 */
  @media print{
    @page{size:A4;margin:12mm 10mm 14mm 10mm}
    body{background:#fff;color:#000}
    header{color:#000;border-bottom:1px solid #ddd}
    .btn{display:none}
    footer{color:#333;border-top:1px solid #ddd}
  }
  /* Estilos del interruptor */
  #toggleMark:checked{background:#5B7EAE;border-color:#5B7EAE}
  #toggleMark:checked + .knob{left:19px}
  /* Switch styles (robust) */
  #markSwitch{position:relative}
  #toggleMark:checked ~ .track{background:#5B7EAE;border-color:#5B7EAE}
  #toggleMark:checked ~ .thumb{left:21px}
</style>
</head>
<body>
<div class="app">
  <!-- HEADER -->
  <header><h1>Esquema de lesión muscular</h1></header>

  <!-- PANEL DE DATOS -->
  <section class="panel-datos">
    <div class="fld"><label>Nombre y Apellido</label><input id="inpNombre" placeholder="Apellido, Nombre"/></div>
    <div class="fld"><label>Fecha de lesión</label><input id="inpFecha" type="date"/></div>
    <div class="fld"><label>Miembro</label><select id="selLado"><option value="derecho" selected>Derecho</option><option value="izquierdo">Izquierdo</option></select></div>
    <div class="fld"></div>
    <div class="actions"><button class="btn ghost" id="btnLimpiar">Limpiar</button><button class="btn primary" id="btnPDF">Generar PDF</button></div>
  </section>

  <!-- PANEL SVG + TABS -->
  <section class="svg-panel">
    <!-- Barra de opciones: interruptor para marcar y botón limpiar estrellas -->
    <div class="toolbar" style="display:flex;gap:.75rem;align-items:center;justify-content:space-between;padding:.6rem 0 .2rem 0;color:#1b2435">
      <label id="markSwitch" style="position:relative;display:flex;align-items:center;gap:.5rem;user-select:none;cursor:pointer">
        <input id="toggleMark" type="checkbox" style="appearance:none;width:42px;height:24px;background:#d4dde9;border-radius:999px;position:relative;outline:none;border:1px solid #b9c6d9">
        <span class="knob" style="position:absolute;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.25);left:3px;top:50%;transform:translateY(-50%);"></span>
        <span style="margin-left:48px;font-weight:600;">Activar marcas (★)</span>
      </label>
      <div>
        <button class="btn ghost" id="btnClearPins" title="Eliminar todas las estrellas">Limpiar estrellas</button>
      </div>
    </div>
    <div class="tabs" id="tabs">
      <button class="tab" data-musculo="biceps">Biceps</button>
      <button class="tab" data-musculo="semis">Semis</button>
      <button class="tab active" data-musculo="rac">RAC</button>
      <button class="tab" data-musculo="aductores">Aductores</button>
      <button class="tab" data-musculo="soleo">Sóleo</button>
      <button class="tab" data-musculo="gemelos">Gemelos</button>
    </div>
    <div class="canvas">
      <svg id="panelSVG" viewBox="0 0 1600 900" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
        <rect x="0" y="0" width="1600" height="900" fill="#1c1f25"/>
        <g id="viewport" transform="translate(0,0) scale(1)">
          <g id="artwork"></g>
          <g id="pins"></g>
        </g>
        <g id="placeholder">
          <rect x="80" y="80" width="1440" height="740" fill="#222832" stroke="#3a4250"/>
          <text x="800" y="430" fill="#8fa7c7" font-size="42" text-anchor="middle" font-family="system-ui, -apple-system">Pegaremos aquí el SVG de <tspan id="tMusculo">RAC</tspan> — <tspan id="tLado">derecho</tspan></text>
          <text id="phMsg" x="800" y="490" text-anchor="middle" font-family="system-ui, -apple-system">Subí el archivo faltante a ./svg/<tspan id="phMus">rac</tspan>/<tspan id="phFile">rac-derecho.svg</tspan></text>
        </g>
      </svg>
    </div>
  </section>

  <!-- PANEL CARACTERÍSTICAS -->
  <section class="caract">
    <h2>Características de la lesión</h2>
    <div class="cards">
      <div class="card">
        <h3>Grado</h3>
        <div class="opt" id="optGrado">
          <label><input type="radio" name="grado" value="1"> Grado 1 (a,b)</label>
          <label><input type="radio" name="grado" value="2"> Grado 2 (a,b,c)</label>
          <label><input type="radio" name="grado" value="3"> Grado 3 (a,b,c)</label>
          <label><input type="radio" name="grado" value="4"> Grado 4 (c)</label>
        </div>
      </div>
      <div class="card">
        <h3>Tejido afectado</h3>
        <div class="opt" id="optTejido">
          <label><input type="checkbox" value="miofascial"> Miofascial (a)</label>
          <label><input type="checkbox" value="miotendinoso"> Miotendinoso (b)</label>
          <label><input type="checkbox" value="tendinoso"> Tendinoso (c)</label>
          <label><input type="checkbox" value="intramuscular"> Intramuscular</label>
        </div>
      </div>
      <div class="card">
        <h3>Lesiones asociadas</h3>
        <div class="opt" id="optAsociadas">
          <label><input type="checkbox" value="lamina"> Lámina líquida</label>
          <label><input type="checkbox" value="coleccion"> Colección</label>
          <label><input type="checkbox" value="cicatriz"> Cicatriz fibrosa</label>
          <label><input type="checkbox" value="calcificaciones"> Calcificaciones</label>
          <label><input type="checkbox" value="recidiva"> Recidiva</label>
        </div>
      </div>
    </div>
  </section>

  <footer>Desarrollado por Santiago Grosso</footer>
</div>

<script>
(() => {
  // ===== Config =====
  const BASE_SVG_PATH = './svg'; // ./svg/<musculo>/<musculo>-<lado>.svg
  const $ = (s) => document.querySelector(s);
  const $$ = (s) => Array.from(document.querySelectorAll(s));
  let musculo = 'rac';
  let lado = 'derecho';

  // DOM refs
  const panelSVG = document.getElementById('panelSVG');
  const viewport = document.getElementById('viewport');
  const artwork  = document.getElementById('artwork');
  const pins     = document.getElementById('pins');
  const ph       = document.getElementById('placeholder');
  const phMus    = document.getElementById('phMus');
  const phFile   = document.getElementById('phFile');
  const tMus     = document.getElementById('tMusculo');
  const tLado    = document.getElementById('tLado');

  // ===== Carga de SVG =====
  function loadSVG(){
    if(!artwork) return Promise.resolve();
    const path = `${BASE_SVG_PATH}/${musculo}/${musculo}-${lado}.svg`;
    if(phMus)  phMus.textContent  = musculo;
    if(phFile) phFile.textContent = `${musculo}-${lado}.svg`;
    if(tMus){ const tabEl = document.querySelector(`.tab[data-musculo="${musculo}"]`); tMus.textContent = (tabEl ? tabEl.textContent : musculo).trim(); }
    if(tLado)  tLado.textContent  = lado;

    return fetch(path,{cache:'no-store'}).then(res => {
      if(!res.ok){ if(ph) ph.style.display='block'; artwork.innerHTML=''; console.warn('[SVG] No encontrado:', path); return null; }
      return res.text();
    }).then(txt => {
      if(txt===null) return;
      const doc = new DOMParser().parseFromString(txt,'image/svg+xml');
      const src = doc.querySelector('svg');
      if(!src){ if(ph) ph.style.display='block'; artwork.innerHTML=''; console.warn('[SVG] Sin <svg> raíz:', path); return; }
      artwork.innerHTML='';
      const vb = src.getAttribute('viewBox'); panelSVG.setAttribute('viewBox', vb ? vb : '0 0 1600 900');
      Array.from(src.childNodes).forEach(n => artwork.appendChild(panelSVG.ownerDocument.importNode(n,true)));
      if(ph) ph.style.display='none';
    }).catch(err => { if(ph) ph.style.display='block'; artwork.innerHTML=''; console.warn('[SVG] Error al cargar', path, err?.message||err); });
  }

  // ===== Estrellas =====
  function clearPins(){ if(pins){ while(pins.firstChild) pins.removeChild(pins.firstChild); } }
  const STAR_MIN = 10, STAR_MAX = 56;
  const svgPoint = (svg, clientX, clientY) => {
    const pt = svg.createSVGPoint(); pt.x=clientX; pt.y=clientY; return pt.matrixTransform(svg.getScreenCTM().inverse());
  };
  const starPath = (cx,cy,r,spikes=5) => {
    const inner=r*0.48; let rot=Math.PI/2*3, x=cx, y=cy, step=Math.PI/spikes, d=`M ${cx} ${cy-r}`;
    for(let i=0;i<spikes;i++){ x=cx+Math.cos(rot)*r; y=cy+Math.sin(rot)*r; d+=` L ${x} ${y}`; rot+=step; x=cx+Math.cos(rot)*inner; y=cy+Math.sin(rot)*inner; d+=` L ${x} ${y}`; rot+=step; }
    return d+' Z';
  };

  // Modo (nav|mark) y toggle de marcado
  let mode = 'nav';
  let markEnabled = false; // interruptor arriba del SVG

  const onPointerDownMark = (e) => {
    if(!panelSVG || e.button===2) return;
    if(!markEnabled){ // permitir borrar si toca una estrella, pero no crear
      const isPin = e.target && e.target.classList && e.target.classList.contains('pin');
      if(isPin){ try{ e.target.remove(); }catch(_){} }
      return;
    }
    e.preventDefault?.();
    const isPin = e.target && e.target.classList && e.target.classList.contains('pin');
    if(isPin){ try{ e.target.remove(); }catch(_){} return; }
    const p = svgPoint(panelSVG, e.clientX, e.clientY);
    start = p;
    const path = document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('class','pin');
    path.setAttribute('d', starPath(p.x, p.y, STAR_MIN));
    pins.appendChild(path);
    drawing = path;
    try{ panelSVG.setPointerCapture?.(e.pointerId); }catch(_){}
  };
  const onPointerMoveMark = (e) => {
    if(!drawing) return; e.preventDefault?.();
    const p = svgPoint(panelSVG, e.clientX, e.clientY);
    const dx=p.x-start.x, dy=p.y-start.y; const r=Math.max(STAR_MIN, Math.min(STAR_MAX, Math.hypot(dx,dy)));
    drawing.setAttribute('d', starPath(start.x, start.y, r));
  };
  const endDrawingMark = (e) => { if(!drawing) return; e?.preventDefault?.(); drawing=null; start=null; };
  let drawing=null, start=null;

  // Pan & Zoom (solo para cumplir tests/UX si lo usás)
  let scale=1, MIN_Z=0.6, MAX_Z=3; let tx=0, ty=0; let isPanning=false, lastPan=null, pinchStart=null; // {d,cx,cy,scale,tx,ty}
  const applyView = () => { viewport?.setAttribute('transform',`translate(${tx},${ty}) scale(${scale})`); };
  const onWheel = (e) => { if(mode!=='nav') return; if(!panelSVG) return; e.preventDefault(); const p=svgPoint(panelSVG,e.clientX,e.clientY); const dz=-e.deltaY*0.0012; const ns=Math.min(MAX_Z,Math.max(MIN_Z,scale*(1+dz))); const k=ns/scale; tx=p.x - k*(p.x - tx); ty=p.y - k*(p.y - ty); scale=ns; applyView(); };
  const onPointerDownNav = (e) => { if(!panelSVG) return; panelSVG.setPointerCapture?.(e.pointerId); activePointers.set(e.pointerId,{x:e.clientX,y:e.clientY}); if(activePointers.size===1){ isPanning=true; lastPan=svgPoint(panelSVG,e.clientX,e.clientY); panelSVG.classList.add('grabbing'); } else if(activePointers.size===2){ const pts=[...activePointers.values()]; const a=pts[0], b=pts[1]; const dx=b.x-a.x, dy=b.y-a.y; const d=Math.hypot(dx,dy); const midx=(a.x+b.x)/2, midy=(a.y+b.y)/2; const sp=svgPoint(panelSVG,midx,midy); pinchStart={d, cx:sp.x, cy:sp.y, scale, tx, ty}; } e.preventDefault?.(); };
  const onPointerMoveNav = (e) => { if(!activePointers.has(e.pointerId)) return; activePointers.set(e.pointerId,{x:e.clientX,y:e.clientY}); if(activePointers.size===1 && isPanning){ const p=svgPoint(panelSVG,e.clientX,e.clientY); tx += (p.x-lastPan.x); ty += (p.y-lastPan.y); lastPan=p; applyView(); e.preventDefault?.(); } else if(activePointers.size===2 && pinchStart){ const pts=[...activePointers.values()]; const a=pts[0], b=pts[1]; const dx=b.x-a.x, dy=b.y-a.y; const d=Math.hypot(dx,dy); const midx=(a.x+b.x)/2, midy=(a.y+b.y)/2; const sp=svgPoint(panelSVG,midx,midy); const ns=Math.min(MAX_Z,Math.max(MIN_Z,pinchStart.scale*(d/pinchStart.d))); scale=ns; tx = sp.x - (ns/pinchStart.scale) * (pinchStart.cx - pinchStart.tx); ty = sp.y - (ns/pinchStart.scale) * (pinchStart.cy - pinchStart.ty); applyView(); e.preventDefault?.(); } };
  const onPointerUpNav   = (e) => { activePointers.delete(e.pointerId); if(activePointers.size<=0){ isPanning=false; lastPan=null; pinchStart=null; panelSVG.classList.remove('grabbing'); } };
  const resetView = () => { scale=1; tx=0; ty=0; applyView(); };
  const activePointers = new Map();

  // Listeners principales
  if(panelSVG){
    panelSVG.addEventListener('wheel', onWheel, {passive:false});
    panelSVG.addEventListener('pointerdown', (e)=>{ if(mode==='nav') onPointerDownNav(e); else onPointerDownMark(e); }, {passive:false});
    window.addEventListener('pointermove', (e)=>{ if(mode==='nav') onPointerMoveNav(e); else onPointerMoveMark(e); }, {passive:false});
    window.addEventListener('pointerup',   (e)=>{ if(mode==='nav') onPointerUpNav(e); else endDrawingMark(e); }, {passive:false});
    window.addEventListener('pointercancel',(e)=>{ if(mode==='nav') onPointerUpNav(e); else endDrawingMark(e); }, {passive:false});
  }

  // Radio de modo + interruptor de marcado + botones
  $$('input[name="modo"]').forEach(r=> r.addEventListener('change', ()=>{ mode = (r.value==='mark') ? 'mark' : 'nav'; }));
  const toggleMark = document.getElementById('toggleMark');
  if(toggleMark){ toggleMark.addEventListener('change', ()=>{ markEnabled = !!toggleMark.checked; }); }
  const btnResetView = document.getElementById('btnResetView'); if(btnResetView) btnResetView.addEventListener('click', resetView);
  const btnClearPins = document.getElementById('btnClearPins'); if(btnClearPins) btnClearPins.addEventListener('click', clearPins);

  // Tabs
  const tabsEl = document.getElementById('tabs');
  if(tabsEl){
    tabsEl.addEventListener('click', (e)=>{
      const t = e.target.closest?.('.tab');
      if(!t) return;
      $$('#tabs .tab').forEach(o=>o.classList.remove('active'));
      t.classList.add('active');
      musculo = t.getAttribute('data-musculo');
      clearPins(); loadSVG();
    });
  }

  // Lado
  const selLado = document.getElementById('selLado');
  if(selLado){ selLado.addEventListener('change', ()=>{ lado = selLado.value; clearPins(); loadSVG(); }); }

  // Botones generales
  const btnPDF    = document.getElementById('btnPDF');    if(btnPDF)    btnPDF.addEventListener('click', ()=>window.print());
  const btnLimpiar= document.getElementById('btnLimpiar'); if(btnLimpiar) btnLimpiar.addEventListener('click', ()=>{
    const nombre=$('#inpNombre'); if(nombre) nombre.value='';
    const fecha=$('#inpFecha');   if(fecha)  fecha.value='';
    $$('#optGrado input[type=radio]').forEach(r=>r.checked=false);
    $$('#optTejido input[type=checkbox],#optAsociadas input[type=checkbox]').forEach(c=>c.checked=false);
    clearPins();
  });

  // ===== TESTS =====
  function assert(cond,msg){ if(!cond){ console.error('[TEST FAIL]',msg); return false;} console.log('[TEST OK]',msg); return true; }
  const tests=[
    ()=>assert(!!document.getElementById('tabs'),'Existe barra de tabs'),
    ()=>assert(document.querySelectorAll('#tabs .tab').length===6,'Hay 6 pestañas'),
    ()=>assert(!!document.getElementById('selLado'),'Existe selector de lado'),
    ()=>assert(!!document.getElementById('panelSVG'),'Existe panel SVG'),
    ()=>assert(typeof loadSVG==='function','loadSVG definida'),
    ()=>{ try{ const p=loadSVG(); return assert(p instanceof Promise || p===undefined,'loadSVG no arroja'); }catch(e){ return assert(false,'loadSVG no debería arrojar'); } },
    ()=>assert(!!document.querySelector('input[name="modo"][value="nav"]') && !!document.querySelector('input[name="modo"][value="mark"]'),'Switch de modo presente'),
    ()=>assert(!!document.getElementById('btnClearPins') && !!document.getElementById('btnResetView'),'Botones auxiliares presentes'),
    ()=>assert(!!document.getElementById('toggleMark'),'Toggle de marcado presente'),
    ()=>{ // intentar crear con toggle OFF => no debe cambiar conteo
      const toggle=document.getElementById('toggleMark'); if(toggle){ toggle.checked=false; toggle.dispatchEvent(new Event('change')); }
      const before=pins.childElementCount; const rect=panelSVG.getBoundingClientRect();
      try{ const down=new PointerEvent('pointerdown',{clientX:rect.left+60,clientY:rect.top+60,pointerId:11}); panelSVG.dispatchEvent(down);}catch(_){}
      const after=pins.childElementCount; return assert(after===before,'Con marcado OFF NO se agregan estrellas');
    }
  ];
  tests.forEach(t=>{ try{ t(); }catch(e){ console.error('[TEST ERROR]', e); } });

  // Carga inicial
  loadSVG();
})();
</script>
</body>
</html>

