<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Esquema de lesi√≥n muscular ‚Äî v2.5.3 (photos)</title>
<style>
  :root{
    --bg:#0f1115; --ink:#0e1320; --muted:#6b7890; --accent:#5B7EAE; --accent-weak:#8fa7c7;
    --panel:#ffffff; --line:#e7ecf3; --overlay:rgba(24,30,44,.85);
    --tab-active:#4D4C4C;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:#fff}
  .app{min-height:100dvh;display:grid;grid-template-rows:auto auto 1fr auto}

  header{padding:1rem 1.25rem;border-bottom:1px solid rgba(255,255,255,.1);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,0))}
  header h1{margin:0;font-size:1.35rem;letter-spacing:.2px}

  .panel-datos{background:var(--panel);color:var(--ink);padding:1rem 1.25rem;border-bottom:1px solid var(--line);display:flex;flex-wrap:wrap;align-items:end;gap:.8rem;overflow-x:visible}
  .panel-datos .fld{min-width:220px}
  .panel-datos .actions{min-width:max-content;display:flex;gap:.5rem;margin-left:auto;align-items:center}
  .fld{display:flex;flex-direction:column;gap:.35rem}
  .fld label{font-size:.85rem;color:#53607a}
  .fld input{padding:.6rem .7rem;border:1px solid var(--line);border-radius:.6rem}
  .btn{appearance:none;border:none;border-radius:.6rem;padding:.65rem 1rem;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--accent);color:#0d1117}
  .btn.ghost{background:transparent;border:1px solid var(--accent-weak);color:#1b2435}

  .svg-panel{background:var(--panel);color:var(--ink);padding:0 1.25rem 1rem 1.25rem;border-bottom:1px solid var(--line)}
  .toolbar{display:flex;gap:1rem;align-items:center;justify-content:space-between;padding:.6rem 0 .2rem 0;color:#1b2435;position:relative;z-index:10}
  .tabs{display:flex;gap:.25rem;flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:thin;padding-top:.6rem;position:relative;z-index:2;background:#fff;border-bottom:1px solid var(--line)}
  .tab{appearance:none;border:1px solid var(--line);background:#f6f8fb;color:#1b2435;padding:.55rem .9rem;border-top-left-radius:.75rem;border-top-right-radius:.75rem;cursor:pointer;font-weight:700;flex:0 0 auto;-webkit-tap-highlight-color: rgba(0,0,0,0);} 
  .tab.active{background:var(--tab-active);color:#fff;border-color:var(--tab-active);border-bottom-color:transparent;box-shadow:0 -6px 24px rgba(0,0,0,.12)}
  .canvas{border:1px solid var(--line);border-top:none;border-radius:0 0 .9rem .9rem;overflow:hidden;background:#1c1f25;position:relative;z-index:1}
  .canvas svg{display:block;width:100%;height:auto;touch-action:none}

  .pin{stroke-width:.8;pointer-events:auto;cursor:pointer}
  .free{stroke-width:1.4;stroke-linecap:round;stroke-linejoin:round;pointer-events:auto;cursor:pointer}
  .line{fill:none;stroke-width:1.4;stroke-linecap:round;pointer-events:auto;cursor:pointer}
  .shape{stroke-width:.8;pointer-events:auto;cursor:pointer}
  .label{font: 400 26px/1.1 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; pointer-events:auto; cursor:move}
  #placeholder text{user-select:none}
  #phMsg{fill:#c7d6eb;font-size:18px}

  .tools-toggle{position:absolute;left:10px;top:10px;z-index:5}
  .tools-toggle .tbtn{width:38px;height:38px;border-radius:10px;border:1px solid #95a6c1;background:#eaf0f8;color:#132033;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
  .tools-panel{position:absolute;left:10px;top:58px;width:48px;border-radius:12px;padding:8px;background:var(--overlay);backdrop-filter:blur(6px);border:1px solid rgba(149,166,193,.45);display:none;z-index:6}
  .tools-panel.open{display:block}
  .tool{width:32px;height:32px;border-radius:8px;border:1px solid rgba(231,236,243,.25);background:transparent;color:#e8eef7;display:flex;align-items:center;justify-content:center;cursor:pointer;margin:6px 0;position:relative}
  .tool.active{background:rgba(231,236,243,.15);border-color:#e7ecf3}
  .tool svg{width:18px;height:18px}

  .palette{position:absolute;left:56px;top:0;display:none;grid-template-columns:repeat(3,22px);gap:8px;width:max-content;background:var(--overlay);border:1px solid rgba(149,166,193,.45);padding:8px;border-radius:10px}
  .palette.open{display:grid}
  .sw{width:22px;height:22px;border-radius:6px;border:1px solid rgba(255,255,255,.9);cursor:pointer}
  .sw.active{outline:2px solid #fff}
  .color-chip{width:14px;height:14px;border-radius:3px;border:1px solid rgba(0,0,0,.25);display:block}

  .caract{background:var(--panel);color:var(--ink);padding:1rem 1.25rem 1.25rem;border-top:1px solid var(--line);position:relative}
  .caract h2{margin:.2rem 0 1rem 0;font-size:1.05rem;text-align:center;text-transform:uppercase}
  .gradoModeWrap{position:absolute;right:1.25rem;top:1rem}
  .segbox{display:inline-flex;border:1px solid #b9c6d9;border-radius:.6rem;overflow:hidden}
  .segbox button{padding:.35rem .65rem;border:0;background:#f6f8fb;color:#0e1320;font-weight:700}
  .segbox button.active{background:#e8eef7}
  .cards{display:grid;grid-template-columns:repeat(3,minmax(300px,1fr));gap:1rem;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:thin}
  .card{border:1px solid var(--line);border-radius:.9rem;background:#fff;padding:.9rem;text-align:left}
  .card h3{text-transform:uppercase;margin:.1rem 0 .6rem 0;font-size:.95rem;color:#1b2435;text-align:center}
  .opt{display:grid;gap:.6rem}
  .opt label{display:flex;align-items:center;gap:.5rem;justify-content:flex-start;text-align:left;padding-left:.25rem;white-space:normal}
  .opt input{margin-right:.25rem}
  .opt.munich label{white-space:nowrap;font-size:.9rem}

  footer{padding:.8rem 1.25rem;color:#97a6bf;font-size:.9rem;border-top:1px solid rgba(255,255,255,.1)}

  /* Impresi√≥n A4 */
  @media print{
    @page{size:A4;margin:12mm 10mm 14mm 10mm}
    body{background:#fff;color:#000}
    header{color:#000;border-bottom:1px solid #ddd}
    .btn,.tools-toggle,.tools-panel,.palette{display:none!important}
    footer{color:#333;border-top:1px solid #ddd}
    #photoMenu{display:none!important;}
  }

  .text-editor{position:fixed;z-index:9999;padding:.2rem .35rem;border:1px solid #6b7890;border-radius:.35rem;background:#fff;color:#111;min-width:40px;font:400 18px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}

  /* Selecci√≥n + manijas */
  .sel-box{ fill:none; stroke:#fff; stroke-width:1.5; stroke-dasharray:5 3; pointer-events:none; vector-effect:non-scaling-stroke; }
  .handle{ fill:#fff; stroke:none; width:8px; height:8px; pointer-events:all; cursor:pointer; }
  .handle.rotate{ fill:#FFD600; stroke:none; r:6; }

  /* Contenedor de fotos para impresi√≥n */
  .photos-print{ display:none; }
  @media print{
    .photos-print{ display:block; page-break-before:always; }
    .photos-print .print-page{ page-break-after:always; }
    .photos-print .print-page:last-child{ page-break-after:auto; }
    .photos-print .print-img{ width:100%; height:auto; display:block; margin:0 0 8mm 0; }
  }
/* ===== Modal recorte (tu overlay, sin conflictos) ===== */
.photo-modal{
  position: fixed; inset: 0;
  background: rgba(0,0,0,.6);     /* oscurece el fondo */
  display: none; z-index: 2147483647;  /* por encima de todo */
  padding: 4vh 4vw;
}
.photo-modal .cropper-dialog{
  background:#ffffff;
  color:#0e1320;
  border-radius:12px; overflow:hidden;
  display:flex; flex-direction:column; height:100%;
  border:1px solid #d9e1ec;
  box-shadow: 0 18px 48px rgba(0,0,0,.2);
}
.photo-modal .cropper-header{
  padding:.8rem 1rem; border-bottom:1px solid #e7ecf3;
}
.photo-modal .cropper-body{
  position:relative; flex:1; background:#fff;
  display:flex; align-items:center; justify-content:center; min-height:200px;
}
.photo-modal .cropper-body img{
  max-width:100%; max-height:100%; display:block; opacity:1;
}
.photo-modal .cropper-footer{
  padding:.8rem 1rem; border-top:1px solid #e7ecf3;
  display:flex; justify-content:flex-end; gap:.5rem; background:#f6f8fb;
}

/* No imprimir tu modal */
@media print{
  .photo-modal{ display:none !important; }
}

/* ===== Overrides de Cropper para evitar velos extras ===== */
/* Si igual ves ‚Äúvelo‚Äù dentro del recorte, forzamos transparencia: */
.cropper-container .cropper-modal{
  background: transparent !important;   /* m√°scara interna de Cropper */
}

</style>
  <!-- Cropper.js ‚Äî estilos y script -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css">
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>
</head>
<body>
<div class="app">
  <header><h1>Esquema de lesi√≥n muscular</h1></header>

  <section class="panel-datos">
    <div class="fld"><label>Nombre y Apellido</label><input id="inpNombre" placeholder="Apellido, Nombre"/></div>
    <div class="fld"><label>Fecha de lesi√≥n</label><input id="inpFecha" type="date"/></div>
 <div class="actions">
  <button class="btn ghost" id="btnAddPhoto" title="Agregar im√°genes">Agregar im√°genes</button>
  <button class="btn primary" id="btnPDF">Generar PDF</button>
  <!-- √önico input: abre galer√≠a/archivos -->
  <input id="inpPhotoGal" type="file" accept="image/*" multiple hidden>
</div>
  </section>

  <section class="svg-panel">
    <div class="toolbar">
      <div style="display:flex;gap:1rem;align-items:center;flex-wrap:wrap">
        <div id="sideToggle" class="segbox">
          <button type="button" class="seg seg-left active" data-side="derecho">D</button>
          <button type="button" class="seg seg-right" data-side="izquierdo">I</button>
        </div>
        <button class="btn ghost" id="btnClearPins" title="Eliminar todas las marcas">Limpiar marcas</button>
      </div>
    </div>
    <div class="tabs" id="tabs">
      <button class="tab" data-musculo="biceps">B√≠ceps femoral</button>
      <button class="tab" data-musculo="semis">Semitendinoso/Semimembranoso</button>
      <button class="tab active" data-musculo="rac">Recto anterior del cu√°driceps</button>
      <button class="tab" data-musculo="aductores">Aductores</button>
      <button class="tab" data-musculo="gemelos">Gemelos</button>
      <button class="tab" data-musculo="soleo">S√≥leo</button>
    </div>
    <div class="canvas">
      <div class="tools-toggle"><button id="btnTools" class="tbtn" title="Herramientas" aria-label="Herramientas">üß∞</button></div>
      <div id="tools" class="tools-panel" aria-hidden="true">
        <button class="tool" data-tool="star" title="Estrella" aria-label="Estrella">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3l2.9 5.9 6.5.9-4.7 4.6 1.1 6.5L12 18.9 6.2 21l1.1-6.5L2.6 9.8l6.5-.9L12 3z"/></svg>
        </button>
        <button class="tool" data-tool="shape" title="Forma (estallido)" aria-label="Forma">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l2 3 3-1-1 3 3 1-3 2 2 3-3-1-1 3-2-2-3 2 1-3-3 1 2-3-3-2 3-1-1-3 3 1z"/></svg>
        </button>
        <button class="tool" data-tool="free" title="Dibujo libre" aria-label="Dibujo libre">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 15c2-2 4-2 6 0s4 2 6 0 4-2 6 0"/></svg>
        </button>
        <button class="tool" data-tool="line" title="L√≠nea" aria-label="L√≠nea">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 20 L20 4"/></svg>
        </button>
        <button class="tool" data-tool="text" title="Texto" aria-label="Texto">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M5 4h14v2h-6v14h-2V6H5z"/></svg>
        </button>
        <button class="tool" data-tool="color" title="Color" aria-label="Color">
          <span class="color-chip" id="colorChip"></span>
        </button>
        <div id="palette" class="palette" aria-hidden="true">
          <button class="sw" data-color="#FF1744" style="background:#FF1744"></button>
          <button class="sw" data-color="#2962FF" style="background:#2962FF"></button>
          <button class="sw" data-color="#00C853" style="background:#00C853"></button>
          <button class="sw" data-color="#FF9100" style="background:#FF9100"></button>
          <button class="sw" data-color="#FFD600" style="background:#FFD600"></button>
          <button class="sw" data-color="#000000" style="background:#000000"></button>
         <!-- Slider de transparencia (solo barrita) -->
<div class="alpha-wrap" style="grid-column:1 / -1; padding-top:4px;">
  <input id="alphaRange" type="range" min="10" max="100" value="70" step="1"
         style="width:100%; accent-color:#FFD600;">

</div>
        </div>
        <button class="tool" data-tool="erase" title="Borrar" aria-label="Borrar">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 3l5 5-9 9H7L2 12l9-9h5zM7 17h10v2H7z"/></svg>
        </button>
        <button class="tool" data-tool="undo" title="Deshacer" aria-label="Deshacer">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" 
       stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M3 7l5-5"/>
    <path d="M3 7h10a7 7 0 1 1 0 14h-3"/>
  </svg>
</button>
        <button class="tool" data-tool="redo" title="Rehacer" aria-label="Rehacer">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" 
       stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M21 7l-5-5"/>
    <path d="M21 7H11a7 7 0 1 0 0 14h3"/>
  </svg>
</button>
      </div>

      <svg id="panelSVG" viewBox="0 0 1600 900" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
        <rect x="0" y="0" width="1600" height="900" fill="#4D4C4C"/>
        <g id="artwork"></g>
        <g id="pins"></g>
        <g id="free"></g>
        <g id="lines"></g>
        <g id="labels"></g>
        <g id="transformOverlay"></g>
        <g id="placeholder">
          <rect x="80" y="80" width="1440" height="740" fill="#222832" stroke="#3a4250"/>
          <text x="800" y="430" fill="#8fa7c7" font-size="42" text-anchor="middle" font-family="system-ui, -apple-system">Pegaremos aqu√≠ el SVG de <tspan id="tMusculo">RAC</tspan> ‚Äî <tspan id="tLado">derecho</tspan></text>
          <text id="phMsg" x="800" y="490" text-anchor="middle" font-family="system-ui, -apple-system">Sub√≠ el archivo faltante a ./svg/<tspan id="phMus">rac</tspan>/<tspan id="phFile">rac-derecho.svg</tspan></text>
        </g>
      </svg>
    </div>
  </section>

  <section class="caract">
    <h2>Caracter√≠sticas de la lesi√≥n</h2>
    <div class="gradoModeWrap">
      <div id="gradoMode" class="segbox" role="tablist" aria-label="Selector de sistema de grado">
        <button type="button" class="active" data-mode="bamic">BAMIC</button>
        <button type="button" data-mode="munich">MUNICH</button>
        <button type="button" data-mode="clasica">CL√ÅSICA</button>
      </div>
    </div>

    <div class="cards">
      <div class="card" id="cardGrado">
        <h3>Grado</h3>
        <div class="opt" id="gradoOptions" aria-live="polite">
          <label><input type="radio" name="grado" value="Grado 1"> Grado 1</label>
          <label><input type="radio" name="grado" value="Grado 2"> Grado 2</label>
          <label><input type="radio" name="grado" value="Grado 3"> Grado 3</label>
          <label><input type="radio" name="grado" value="Grado 4"> Grado 4</label>
        </div>
      </div>
      <div class="card" id="cardTejido">
        <h3>Tejido afectado</h3>
        <div class="opt" id="optTejido">
          <label><input type="checkbox" value="Miofascial (a)"> Miofascial (a)</label>
          <label><input type="checkbox" value="Miotendinoso (b)"> Miotendinoso (b)</label>
          <label><input type="checkbox" value="Tendinoso (c)"> Tendinoso (c)</label>
          <label><input type="checkbox" value="Intramuscular"> Intramuscular</label>
        </div>
      </div>
      <div class="card" id="cardAsociadas">
        <h3>Lesiones asociadas</h3>
        <div class="opt" id="optAsociadas">
          <label><input type="checkbox" value="L√°mina l√≠quida"> L√°mina l√≠quida</label>
          <label><input type="checkbox" value="Colecci√≥n"> Colecci√≥n</label>
          <label><input type="checkbox" value="Cicatriz fibrosa"> Cicatriz fibrosa</label>
          <label><input type="checkbox" value="Calcificaciones"> Calcificaciones</label>
        </div>
      </div>
    </div>
  </section>

  <!-- Fotos para imprimir (ocultas en pantalla, visibles s√≥lo en PDF/print) -->
  <section id="photosPrint" class="photos-print" aria-hidden="true"></section>

  <footer>Desarrollado por Santiago Grosso</footer>
</div>

<!-- Modal de recorte  ‚úÖ MOVER AQU√ç, antes del <script> -->
<div id="cropperModal" class="photo-modal" aria-hidden="true" style="display:none;">
  <div class="cropper-dialog">
    <div class="cropper-header">
      <strong>Recortar imagen</strong>
    </div>
    <div class="cropper-body">
      <img id="cropperImage" alt="Ajust√° el encuadre">
    </div>
    <div class="cropper-footer">
      <button type="button" id="cropCancel" class="btn ghost">Cancelar</button>
      <button type="button" id="cropUse" class="btn primary">Usar imagen</button>
    </div>
  </div>
</div>
<script>
(function(){
  var BASE_SVG_PATH = './svg';
  var $ = function(s){ return document.querySelector(s); };
  var $$ = function(s){ return Array.prototype.slice.call(document.querySelectorAll(s)); };
  var musculo = 'rac';
  var lado = 'derecho';

  var currentTool = null;
  var currentColor = '#FFD600';
  var currentAlpha = 0.70;
  
  var undoStack = []; var redoStack = [];
  function pushAdd(el){ undoStack.push({type:'add', el:el, parent:el.parentNode, nextSibling:el.nextSibling}); redoStack.length=0; }
  function pushRemove(el,parent,next){ undoStack.push({type:'remove', el:el, parent:parent, nextSibling:next}); redoStack.length=0; }
  function cmdUndo(){ var op=undoStack.pop(); if(!op) return; if(op.type==='add'){ var p=op.parent; var e=op.el; if(e && e.parentNode){ var ns=e.nextSibling; p.removeChild(e); redoStack.push({type:'remove', el:e, parent:p, nextSibling:ns}); } } else if(op.type==='remove'){ if(op.parent){ op.parent.insertBefore(op.el, op.nextSibling||null); redoStack.push({type:'add', el:op.el, parent:op.parent, nextSibling:op.nextSibling}); } } }
  function cmdRedo(){ var op=redoStack.pop(); if(!op) return; if(op.type==='add'){ if(op.parent){ op.parent.insertBefore(op.el, op.nextSibling||null); undoStack.push({type:'add', el:op.el, parent:op.parent, nextSibling:op.nextSibling}); } } else if(op.type==='remove'){ var e=op.el; var p=e && e.parentNode; if(p){ var ns=e.nextSibling; p.removeChild(e); undoStack.push({type:'remove', el:e, parent:p, nextSibling:ns}); } } }

  function darken(hex, amt){ var h = hex.replace('#',''); if(h.length===3){ h=h[0]+h[0]+h[1]+h[1]+h[2]+h[2]; } var r=parseInt(h.substr(0,2),16), g=parseInt(h.substr(2,2),16), b=parseInt(h.substr(4,2),16); r=Math.max(0, Math.min(255, r - Math.round(255*amt))); g=Math.max(0, Math.min(255, g - Math.round(255*amt))); b=Math.max(0, Math.min(255, b - Math.round(255*amt))); var toHex=function(n){ var s=n.toString(16); return s.length===1?'0'+s:s; }; return '#'+toHex(r)+toHex(g)+toHex(b); }
  function applyColorChip(){ var chip=$('#colorChip'); if(chip){ chip.style.background = currentColor; chip.style.borderColor = darken(currentColor, .35); } }

  var panelSVG = document.getElementById('panelSVG');
  var artwork  = document.getElementById('artwork');
  var pins     = document.getElementById('pins');
  var freeGrp  = document.getElementById('free');
  var linesGrp = document.getElementById('lines');
  var labelsGrp = document.getElementById('labels');
  var ph       = document.getElementById('placeholder');
  var phMus    = document.getElementById('phMus');
  var phFile   = document.getElementById('phFile');
  var tMus     = document.getElementById('tMusculo');
  var tLado    = document.getElementById('tLado');
  var overlay  = document.getElementById('transformOverlay');

  function loadSVG(){
    if(!artwork) return Promise.resolve();
    var path = BASE_SVG_PATH + '/' + musculo + '/' + musculo + '-' + lado + '.svg';
    if(phMus) phMus.textContent=musculo;
    if(phFile) phFile.textContent=musculo+'-'+lado+'.svg';
    if(tMus){ var tabEl=document.querySelector('.tab[data-musculo="'+musculo+'"]'); tMus.textContent=(tabEl?tabEl.textContent:musculo).trim(); }
    if(tLado) tLado.textContent=lado;
    return fetch(path,{cache:'no-store'})
    .then(function(res){ if(!res.ok){ if(ph) ph.style.display='block'; artwork.innerHTML=''; console.warn('[SVG] No encontrado:', path); return null; } return res.text(); })
    .then(function(txt){
      if(txt===null) return;
      var doc=new DOMParser().parseFromString(txt,'image/svg+xml');
      var src=doc.querySelector('svg');
      if(!src){ if(ph) ph.style.display='block'; artwork.innerHTML=''; console.warn('[SVG] Sin <svg> ra√≠z:', path); return; }
      artwork.innerHTML='';
      var vb=src.getAttribute('viewBox');
      panelSVG.setAttribute('viewBox', vb ? vb : '0 0 1600 900');
      Array.prototype.slice.call(src.childNodes).forEach(function(n){ artwork.appendChild(panelSVG.ownerDocument.importNode(n,true)); });
      if(ph) ph.style.display='none';
      drawHandles();
    }).catch(function(err){
      if(ph) ph.style.display='block'; artwork.innerHTML=''; console.warn('[SVG] Error al cargar', path, (err && err.message) || err);
    });
  }

  function clearPins(){ if(pins){ while(pins.firstChild) pins.removeChild(pins.firstChild); } }
  function clearFree(){ var arr=document.querySelectorAll('#free path'); for(var i=0;i<arr.length;i++){ var p=arr[i]; p.parentNode.removeChild(p);} }
  function clearLines(){ var arr=document.querySelectorAll('#lines line'); for(var i=0;i<arr.length;i++){ var p=arr[i]; p.parentNode.removeChild(p);} }
  function clearLabels(){ if(labelsGrp){ while(labelsGrp.firstChild) labelsGrp.removeChild(labelsGrp.firstChild);} var editors=document.querySelectorAll('.text-editor'); for(var i=0;i<editors.length;i++){ editors[i].parentNode.removeChild(editors[i]); } }

  var STAR_MIN = 10, STAR_MAX = 56; var SHAPE_MIN = 18, SHAPE_MAX = 80;
  var svgPointFn = function(svg, clientX, clientY){ var pt=svg.createSVGPoint(); pt.x=clientX; pt.y=clientY; return pt.matrixTransform(svg.getScreenCTM().inverse()); };
  var svgPoint = function(clientX, clientY){ return svgPointFn(panelSVG, clientX, clientY); };
  var starPath = function(cx,cy,r,spikes){ if(spikes==null) spikes=5; var inner=r*0.48; var rot=Math.PI/2*3, x=cx, y=cy, step=Math.PI/spikes, d='M '+cx+' '+(cy-r); for(var i=0;i<spikes;i++){ x=cx+Math.cos(rot)*r; y=cy+Math.sin(rot)*r; d+=' L '+x+' '+y; rot+=step; x=cx+Math.cos(rot)*inner; y=cy+Math.sin(rot)*inner; d+=' L '+x+' '+y; rot+=step; } return d+' Z'; };
  function burstPath(cx,cy,r,points,ratio){ if(points==null) points=14; if(ratio==null) ratio=0.45; var d=''; for(var i=0;i<points;i++){ var ang=(i/points)*Math.PI*2; var rr=(i%2===0)? r : r*ratio; var x=cx+Math.cos(ang)*rr; var y=cy+Math.sin(ang)*rr; d += (i===0? 'M ':' L ')+x+' '+y; } return d+' Z'; }

  var drawing=null, start=null; var freePath=null, freeD='', freeStart=null, freeLast=null; var lineEl=null, lineStart=null; var shapeEl=null, shapeStart=null;

  function startStar(e){ var p=svgPoint(e.clientX, e.clientY); start=p; var path=document.createElementNS('http://www.w3.org/2000/svg','path'); path.setAttribute('class','pin');
path.setAttribute('fill', currentColor);
path.setAttribute('fill-opacity', currentAlpha);   // ‚úÖ SOLO relleno con opacidad
path.setAttribute('stroke', darken(currentColor,.3));
path.setAttribute('stroke-width','.8');
path.setAttribute('stroke-opacity','1');           // ‚úÖ borde siempre s√≥lido
path.setAttribute('d', starPath(p.x,p.y,STAR_MIN)); pins.appendChild(path); pushAdd(path); drawing=path; ensureData(path); }
  function updateStar(e){ if(!drawing) return; var p=svgPoint(e.clientX, e.clientY); var dx=p.x-start.x, dy=p.y-start.y; var r=Math.max(STAR_MIN, Math.min(STAR_MAX, Math.hypot(dx,dy))); drawing.setAttribute('d', starPath(start.x,start.y,r)); }
  function endStar(){ drawing=null; start=null; setTool(null); }

  function startFree(e){ var p=svgPoint(e.clientX, e.clientY); freeStart=p; freeLast=p; freeD='M '+p.x+' '+p.y; freePath=document.createElementNS('http://www.w3.org/2000/svg','path'); freePath.setAttribute('class','free');
freePath.setAttribute('stroke', darken(currentColor,.25));
freePath.setAttribute('stroke-width','1.2');
freePath.setAttribute('stroke-opacity','1');  // ‚úÖ borde s√≥lido
freePath.setAttribute('fill','none');         // sin fill mientras est√° abierto
 freePath.setAttribute('d', freeD); freeGrp.appendChild(freePath); pushAdd(freePath); ensureData(freePath); }
  function updateFree(e){ if(!freePath) return; var p=svgPoint(e.clientX, e.clientY); freeD += ' L '+p.x+' '+p.y; freePath.setAttribute('d', freeD); freeLast=p; }
  function endFree(e){ if(!freePath) return; var last = freeLast || freeStart; var dist=Math.hypot(last.x-freeStart.x, last.y-freeStart.y); if(dist<24 && freeD.split('L').length>6){
  freeD += ' Z';
  freePath.setAttribute('d', freeD);
  freePath.setAttribute('fill', currentColor);
  freePath.setAttribute('fill-opacity', currentAlpha);   // ‚úÖ SOLO relleno con opacidad
  freePath.setAttribute('stroke', darken(currentColor,.35));
  freePath.setAttribute('stroke-opacity','1');           // ‚úÖ borde s√≥lido
}
 freePath=null; freeD=''; freeStart=null; freeLast=null; setTool(null); }

  function startLine(e){ var p=svgPoint(e.clientX, e.clientY); lineStart=p; lineEl=document.createElementNS('http://www.w3.org/2000/svg','line'); lineEl.setAttribute('class','line'); lineEl.setAttribute('x1', p.x); lineEl.setAttribute('y1', p.y); lineEl.setAttribute('x2', p.x); lineEl.setAttribute('y2', p.y); lineEl.setAttribute('stroke', darken(currentColor,.25));
lineEl.setAttribute('stroke-width','1.2');
lineEl.setAttribute('stroke-opacity','1');  // ‚úÖ s√≥lido
 linesGrp.appendChild(lineEl); pushAdd(lineEl); ensureData(lineEl); }
  function updateLine(e){ if(!lineEl) return; var p=svgPoint(e.clientX, e.clientY); lineEl.setAttribute('x2', p.x); lineEl.setAttribute('y2', p.y); }
  function endLine(e){ if(!lineEl) return; var p=svgPoint(e.clientX, e.clientY); var len=Math.hypot(p.x-lineStart.x, p.y-lineStart.y); if(len<6){ var parent=lineEl.parentNode; var next=lineEl.nextSibling; parent.removeChild(lineEl); undoStack.pop(); } lineEl=null; lineStart=null; setTool(null); }

  function startShape(e){ var p=svgPoint(e.clientX, e.clientY); shapeStart=p; shapeEl=document.createElementNS('http://www.w3.org/2000/svg','path'); shapeEl.setAttribute('class','shape');
shapeEl.setAttribute('fill', currentColor);
shapeEl.setAttribute('fill-opacity', currentAlpha); // ‚úÖ SOLO relleno con opacidad
shapeEl.setAttribute('stroke', darken(currentColor,.35));
shapeEl.setAttribute('stroke-width','.8');
shapeEl.setAttribute('stroke-opacity','1');         // ‚úÖ borde siempre s√≥lido
shapeEl.setAttribute('d', burstPath(p.x,p.y,SHAPE_MIN,14,0.45)); pins.appendChild(shapeEl); pushAdd(shapeEl); ensureData(shapeEl); }
  function updateShape(e){ if(!shapeEl) return; var p=svgPoint(e.clientX, e.clientY); var dx=p.x-shapeStart.x, dy=p.y-shapeStart.y; var r=Math.max(SHAPE_MIN, Math.min(SHAPE_MAX, Math.hypot(dx,dy))); shapeEl.setAttribute('d', burstPath(shapeStart.x,shapeStart.y,r,14,0.45)); }
  function endShape(){ shapeEl=null; shapeStart=null; setTool(null); }

  function tryErase(target){ if(!target) return; if(target.classList && (target.classList.contains('pin') || target.classList.contains('free') || target.classList.contains('line') || target.classList.contains('shape') || target.classList.contains('label'))){ var parent=target.parentNode; var next=target.nextSibling; parent.removeChild(target); pushRemove(target,parent,next); clearSelection(); } }

  var draggingLabel=null, dragOff={x:0,y:0};
  function placeText(e){ var p=svgPoint(e.clientX, e.clientY); var txt=window.prompt('Ingresar texto:'); if(!txt) return; var t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('class','label'); t.setAttribute('x', p.x); t.setAttribute('y', p.y); t.setAttribute('fill', currentColor);t.setAttribute('fill-opacity', '1'); t.textContent = txt; labelsGrp.appendChild(t); pushAdd(t); ensureData(t); setTool(null); }
  function beginDragLabel(target, e){ var p=svgPoint(e.clientX, e.clientY); draggingLabel=target; var x=parseFloat(target.getAttribute('x')||'0'); var y=parseFloat(target.getAttribute('y')||'0'); dragOff.x = x - p.x; dragOff.y = y - p.y; }
  function moveDragLabel(e){ if(!draggingLabel) return; var p=svgPoint(e.clientX, e.clientY); draggingLabel.setAttribute('x', p.x + dragOff.x); draggingLabel.setAttribute('y', p.y + dragOff.y); }
  function endDragLabel(){ draggingLabel=null; }
  function editLabelInPlace(target){ var bb = target.getBoundingClientRect(); var input = document.createElement('input'); input.className='text-editor'; input.value = target.textContent; input.style.left = (window.scrollX + bb.left)+'px'; input.style.top  = (window.scrollY + bb.top - 8)+'px'; input.style.minWidth = Math.max(40, bb.width)+'px'; document.body.appendChild(input); input.focus(); input.select(); var commit=function(){ var v=input.value.trim(); if(v){ target.textContent=v; } if(input.parentNode){ input.parentNode.removeChild(input);} }; var cancel=function(){ if(input.parentNode){ input.parentNode.removeChild(input);} };
    input.addEventListener('keydown', function(ev){ if(ev.key==='Enter'){ commit(); } else if(ev.key==='Escape'){ cancel(); } }); input.addEventListener('blur', commit);
  }

  var selected = null; var transforming=false; var transformMode=null; var transformInit=null;
  function ensureData(el){ if(!el.getAttribute('data-tx')){ el.setAttribute('data-tx','0'); el.setAttribute('data-ty','0'); el.setAttribute('data-rot','0'); el.setAttribute('data-sx','1'); el.setAttribute('data-sy','1'); } }
  function getData(el){ return { tx:parseFloat(el.getAttribute('data-tx')||'0'), ty:parseFloat(el.getAttribute('data-ty')||'0'), rot:parseFloat(el.getAttribute('data-rot')||'0'), sx:parseFloat(el.getAttribute('data-sx')||'1'), sy:parseFloat(el.getAttribute('data-sy')||'1') }; }
  function setData(el,d){ el.setAttribute('data-tx',d.tx); el.setAttribute('data-ty',d.ty); el.setAttribute('data-rot',d.rot); el.setAttribute('data-sx',d.sx); el.setAttribute('data-sy',d.sy); applyTransform(el); drawHandles(); }
  function applyTransform(el){ var d=getData(el); var bb = el.getBBox(); var cx = bb.x + bb.width/2; var cy = bb.y + bb.height/2; var t = 'translate('+d.tx+' '+d.ty+') translate('+cx+' '+cy+') rotate('+d.rot+') scale('+d.sx+' '+d.sy+') translate('+-cx+' '+-cy+')'; el.setAttribute('transform', t); }

  function beginSelect(el){ if(!el) return; selected = el; ensureData(el); drawHandles(); }
  function clearSelection(){ selected=null; if(overlay){ overlay.innerHTML=''; } }

  function svgPointXY(e){ return svgPoint(e.clientX, e.clientY); }

  function drawHandles(){
    if(!overlay) return;
    overlay.innerHTML = '';
    if(!selected) return;

    var bb = selected.getBBox();
    var x = bb.x, y = bb.y, w = bb.width, h = bb.height;
    var cx = x + w/2, cy = y + h/2;

    var d = getData(selected);
    var sx = d.sx, sy = d.sy, rot = d.rot, tx = d.tx, ty = d.ty;

    var root = document.createElementNS('http://www.w3.org/2000/svg','g');
    var TR = 'translate('+tx+' '+ty+') translate('+cx+' '+cy+') rotate('+rot+') translate('+-cx+' '+-cy+')';
    root.setAttribute('transform', TR);
    overlay.appendChild(root);

    var rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    rect.setAttribute('class','sel-box');
    rect.setAttribute('x', x);
    rect.setAttribute('y', y);
    rect.setAttribute('width',  w);
    rect.setAttribute('height', h);
    rect.setAttribute('transform','translate('+cx+' '+cy+') scale('+sx+' '+sy+') translate('+-cx+' '+-cy+')');
    root.appendChild(rect);

    function scalePoint(px, py){
      return { x: cx + (px - cx) * sx, y: cy + (py - cy) * sy };
    }

    var cornersSrc = [[x,y],[x+w,y],[x,y+h],[x+w,y+h]];
    var sidesSrc   = [[cx,y],[cx,y+h],[x,cy],[x+w,cy]];

    var r = 4;
    function addHandle(cls, hx, hy){
      var hnd = document.createElementNS('http://www.w3.org/2000/svg','rect');
      hnd.setAttribute('class','handle '+cls);
      hnd.setAttribute('x', hx - r);
      hnd.setAttribute('y', hy - r);
      hnd.setAttribute('width',  r*2);
      hnd.setAttribute('height', r*2);
      hnd.setAttribute('data-action', cls);
      root.appendChild(hnd);
    }

    var cNames = ['nw','ne','sw','se'];
    for(var i=0;i<cornersSrc.length;i++){
      var p = scalePoint(cornersSrc[i][0], cornersSrc[i][1]);
      addHandle(cNames[i], p.x, p.y);
    }

    var sNames = ['n','s','w','e'];
    for(var j=0;j<sidesSrc.length;j++){
      var q = scalePoint(sidesSrc[j][0], sidesSrc[j][1]);
      addHandle(sNames[j], q.x, q.y);
    }

    var topScaled = scalePoint(cx, y);
    var rotOffset = 26;
    var rotY = topScaled.y - rotOffset;
    var rotHandle = document.createElementNS('http://www.w3.org/2000/svg','circle');
    rotHandle.setAttribute('class','handle rotate');
    rotHandle.setAttribute('cx', topScaled.x);
    rotHandle.setAttribute('cy', rotY);
    rotHandle.setAttribute('r', 5);
    rotHandle.setAttribute('data-action','rotate');
    root.appendChild(rotHandle);
  }

  function beginMoveSelection(e){ if(!selected) return; transforming=true; transformMode='move'; var p=svgPointXY(e); var d=getData(selected); var bb=selected.getBBox(); transformInit={cx:bb.x+bb.width/2, cy:bb.y+bb.height/2, tx:d.tx, ty:d.ty, sx:d.sx, sy:d.sy, rot:d.rot, mouse:p}; }
  function beginHandleTransform(handle,e){ if(!selected) return; transforming=true; transformMode=handle.getAttribute('data-action'); var p=svgPointXY(e); var d=getData(selected); var bb=selected.getBBox(); transformInit={cx:bb.x+bb.width/2, cy:bb.y+bb.height/2, tx:d.tx, ty:d.ty, sx:d.sx, sy:d.sy, rot:d.rot, mouse:p, ref:{x:parseFloat(handle.getAttribute('x')||handle.getAttribute('cx')||0), y:parseFloat(handle.getAttribute('y')||handle.getAttribute('cy')||0), w:bb.width, h:bb.height}}; }

  function updateTransform(e){
    if(!transforming || !selected) return; 
    var p=svgPointXY(e); var init=transformInit; var d=getData(selected);
    if(transformMode==='move'){
      d.tx = init.tx + (p.x - init.mouse.x); d.ty = init.ty + (p.y - init.mouse.y); setData(selected,d); return;
    }
    if(transformMode==='rotate'){
      var a0 = Math.atan2(init.mouse.y - init.cy, init.mouse.x - init.cx); var a1 = Math.atan2(p.y - init.cy, p.x - init.cx);
      var deg = (a1 - a0)*(180/Math.PI); var raw = init.rot + deg;
      if (!e.altKey){ var step = 15; raw = Math.round(raw/step)*step; }
      d.rot = raw; setData(selected,d); return;
    }
    var dx = (p.x - init.cx), dy = (p.y - init.cy); var dist = Math.hypot(dx,dy);
    var dx0 = (init.mouse.x - init.cx), dy0 = (init.mouse.y - init.cy); var dist0 = Math.max(1, Math.hypot(dx0,dy0));
    var k = dist / dist0;
    var uniform = e.shiftKey;
    if(transformMode==='nw' || transformMode==='ne' || transformMode==='sw' || transformMode==='se'){
      if (uniform){ d.sx = d.sy = Math.max(0.2, Math.min(8, Math.max(init.sx, init.sy) * k)); }
      else { d.sx = Math.max(0.2, Math.min(8, init.sx * k)); d.sy = Math.max(0.2, Math.min(8, init.sy * k)); }
    } else if(transformMode==='n' || transformMode==='s'){
      d.sy = Math.max(0.2, Math.min(8, init.sy * k));
    } else if(transformMode==='w' || transformMode==='e'){
      d.sx = Math.max(0.2, Math.min(8, init.sx * k));
    }
    setData(selected,d);
  }
  function endTransform(){ transforming=false; transformMode=null; transformInit=null; }

  function onPointerDown(e){ if(!panelSVG || e.button===2) return; var t=e.target;
    if(currentTool==='erase'){ if(t && t.classList && (t.classList.contains('pin')||t.classList.contains('free')||t.classList.contains('line')||t.classList.contains('shape')||t.classList.contains('label'))){ tryErase(t); } return; }
    var h = t && t.closest ? t.closest('.handle') : null; if(h){ beginHandleTransform(h,e); return; }
    var drawable = t && t.closest ? t.closest('.pin, .free, .line, .shape, .label') : null; if(drawable){ beginSelect(drawable); beginMoveSelection(e); return; }
    if(currentTool==='star'){ e.preventDefault&&e.preventDefault(); clearSelection(); startStar(e); return; }
    if(currentTool==='shape'){ e.preventDefault&&e.preventDefault(); clearSelection(); startShape(e); return; }
    if(currentTool==='free'){ e.preventDefault&&e.preventDefault(); clearSelection(); startFree(e); return; }
    if(currentTool==='line'){ e.preventDefault&&e.preventDefault(); clearSelection(); startLine(e); return; }
    if(currentTool==='text'){ e.preventDefault&&e.preventDefault(); clearSelection(); placeText(e); return; }
    clearSelection();
  }
  function onPointerMove(e){ if(draggingLabel){ moveDragLabel(e); return; } if(transforming){ updateTransform(e); return; } if(currentTool==='star'){ updateStar(e); } else if(currentTool==='shape'){ updateShape(e); } else if(currentTool==='free'){ updateFree(e); } else if(currentTool==='line'){ updateLine(e); } }
  function onPointerEnd(e){ if(draggingLabel){ endDragLabel(); return; } if(transforming){ endTransform(); return; } if(currentTool==='star'){ endStar(); } else if(currentTool==='shape'){ endShape(); } else if(currentTool==='free'){ endFree(e); } else if(currentTool==='line'){ endLine(e); } }
  function onDoubleClick(e){ var t=e.target; if(t && t.classList && t.classList.contains('label')){ editLabelInPlace(t); } }

  if(panelSVG){ panelSVG.addEventListener('pointerdown', onPointerDown, {passive:false}); window.addEventListener('pointermove', onPointerMove, {passive:false}); window.addEventListener('pointerup', onPointerEnd, {passive:false}); window.addEventListener('pointercancel', onPointerEnd, {passive:false}); panelSVG.addEventListener('dblclick', onDoubleClick); }

  var btnTools = document.getElementById('btnTools'); var toolsPanel = document.getElementById('tools'); var palette = document.getElementById('palette');
  function setTool(name){ currentTool=name; $$('#tools .tool').forEach(function(b){ b.classList.toggle('active', b.getAttribute('data-tool')===name); }); if(name!=='color' && palette){ palette.classList.remove('open'); palette.setAttribute('aria-hidden','true'); } }
  if(btnTools){ btnTools.addEventListener('click', function(){ var open = toolsPanel.classList.toggle('open'); toolsPanel.setAttribute('aria-hidden', open? 'false':'true'); }); }
  if(toolsPanel){ toolsPanel.addEventListener('click', function(ev){ var btn = ev.target.closest ? ev.target.closest('.tool') : null; if(!btn) return; var tool = btn.getAttribute('data-tool'); if(tool==='color'){ if(palette){ var open=palette.classList.toggle('open'); palette.setAttribute('aria-hidden', open? 'false':'true'); } return; } if(tool==='undo'){ cmdUndo(); return; } if(tool==='redo'){ cmdRedo(); return; } setTool(tool); }); }
  if(palette){ palette.addEventListener('click', function(ev){ var sw = ev.target.closest ? ev.target.closest('.sw') : null; if(!sw) return; currentColor = sw.getAttribute('data-color'); applyColorChip(); $$('#palette .sw').forEach(function(s){ s.classList.toggle('active', s===sw); }); }); }

  // === Transparencia (slider) ===
var alphaRange = document.getElementById('alphaRange');
var alphaValue = document.getElementById('alphaValue');

// Funci√≥n para actualizar el valor de transparencia
function setAlphaFromRange(){
  var v = parseInt(alphaRange.value, 10);
  v = isNaN(v) ? 70 : Math.min(100, Math.max(10, v));
  currentAlpha = v / 100; // de 0.10 a 1.00
  if(alphaValue) alphaValue.textContent = v + '%';
}

// Si existe el control, inicializar y escuchar cambios
if(alphaRange){
  setAlphaFromRange(); // valor inicial = 70%
  alphaRange.addEventListener('input', setAlphaFromRange);
}

  var btnClearPins = document.getElementById('btnClearPins'); if(btnClearPins) btnClearPins.addEventListener('click', function(){ clearPins(); clearFree(); clearLines(); clearLabels(); clearSelection(); });
  var btnPDF = document.getElementById('btnPDF'); if(btnPDF) btnPDF.addEventListener('click', function(){ window.print(); });

// === Fotos con recorte (Cropper.js) y maquetado 2 por p√°gina ===
var photos = []; // aqu√≠ quedan las im√°genes finales (recortadas)
var btnAddPhoto = document.getElementById('btnAddPhoto');
var inpPhotoGal = document.getElementById('inpPhotoGal');

// Modal & cropper
var cropper = null;
var cropperModal = document.getElementById('cropperModal');
var cropperImg   = document.getElementById('cropperImage');
var cropCancel   = document.getElementById('cropCancel');
var cropUse      = document.getElementById('cropUse');

// Cola de archivos a recortar (si seleccion√°s varias)
var fileQueue = [];
var currentFile = null;

// Render en el informe (2 por hoja)
function renderPhotosPrint(){
  var cont = document.getElementById('photosPrint');
  if(!cont) return;
  cont.innerHTML='';
  if(!photos.length) return;

  for(var i=0;i<photos.length;i+=2){
    var page = document.createElement('div');
    page.className = 'print-page';
    for(var j=i;j<i+2 && j<photos.length;j++){
      var img = document.createElement('img');
      img.className = 'print-img';
      img.src = photos[j];
      page.appendChild(img);
    }
    cont.appendChild(page);
  }
}

// Abrir modal con una imagen (dataURL) en cropper
function openCropperWithDataURL(dataURL){
  cropperImg.onload = function(){
    // Destruir previa instancia
    if(cropper){ try{ cropper.destroy(); }catch(_){ } cropper = null; }
    // Inicializar cropper
    cropper = new Cropper(cropperImg, {
      viewMode: 1,           // no permitir salir del lienzo
      dragMode: 'move',
      autoCropArea: 1,
      movable: true,
      zoomable: true,
      responsive: true,
      background: false,
      // Relaci√≥n de aspecto recomendada para que el PDF quede prolijo.
      // 4/3 luce muy bien en A4 con 2 por p√°gina. Cambi√° si quer√©s.
      aspectRatio: 4 / 3
    });
  };
  cropperImg.src = dataURL;
  cropperModal.style.display = 'block';
  cropperModal.setAttribute('aria-hidden','false');
}

// Cerrar modal
function closeCropperModal(){
  if(cropper){ try{ cropper.destroy(); }catch(_){ } cropper = null; }
  cropperModal.style.display = 'none';
  cropperModal.setAttribute('aria-hidden','true');
}

// Procesar siguiente archivo de la cola
function processNextFile(){
  if(!fileQueue.length){ currentFile = null; renderPhotosPrint(); return; }
  currentFile = fileQueue.shift();
  var reader = new FileReader();
  reader.onload = function(e){
    openCropperWithDataURL(e.target.result);
  };
  reader.readAsDataURL(currentFile);
}

// Confirmar recorte ‚Üí agregar a photos[] y seguir
if(cropUse){
  cropUse.addEventListener('click', function(){
    if(!cropper) { closeCropperModal(); processNextFile(); return; }
    // Canvas recortado
    var canvas = cropper.getCroppedCanvas({
      // tama√±o de exportaci√≥n (opcional). Si lo omit√≠s, usa el del recorte.
      // width: 1600, height: 1200 // 4:3 (ajust√° si quer√©s)
    });
    var dataURL = canvas.toDataURL('image/jpeg', 0.9);
    photos.push(dataURL);      // sumamos la imagen recortada al informe
    closeCropperModal();
    processNextFile();         // siguiente de la cola
  });
}

// Cancelar recorte ‚Üí no agrega, pero sigue con el siguiente
if(cropCancel){
  cropCancel.addEventListener('click', function(){
    closeCropperModal();
    processNextFile();
  });
}

// Click en "Agregar im√°genes" = abrir galer√≠a
if(btnAddPhoto){
  btnAddPhoto.addEventListener('click', function(){
    if(inpPhotoGal) inpPhotoGal.click();
  });
}

// Al elegir archivos de galer√≠a, encolarlos y comenzar
if(inpPhotoGal){
  inpPhotoGal.addEventListener('change', function(ev){
    var files = Array.prototype.slice.call(ev.target.files || []);
    if(!files.length) return;
    // metemos en la cola y arrancamos si estaba vac√≠a
    var wasIdle = (fileQueue.length===0 && !currentFile);
    fileQueue = fileQueue.concat(files);
    if(wasIdle){ processNextFile(); }
    ev.target.value = ''; // permitir re-seleccionar iguales
  });
}


  // Tabs / Lado
  var tabsEl = document.getElementById('tabs'); if(tabsEl){ tabsEl.addEventListener('click', function(e){ var t = e.target && e.target.closest ? e.target.closest('.tab') : null; if(!t) return; $$('#tabs .tab').forEach(function(o){ o.classList.remove('active'); }); t.classList.add('active'); musculo = t.getAttribute('data-musculo'); clearPins(); clearFree(); clearLines(); clearLabels(); clearSelection(); loadSVG(); }); }
  var sideToggle = document.getElementById('sideToggle'); if(sideToggle){ sideToggle.addEventListener('click', function(ev){ var btn = ev.target && ev.target.closest ? ev.target.closest('button[data-side]') : null; if(!btn) return; Array.prototype.slice.call(sideToggle.querySelectorAll('button[data-side]')).forEach(function(b){ b.classList.remove('active'); }); btn.classList.add('active'); lado = btn.getAttribute('data-side'); clearPins(); clearFree(); clearLines(); clearLabels(); clearSelection(); loadSVG(); }); }

  var gradoMode = document.getElementById('gradoMode'); var gradoOptions = document.getElementById('gradoOptions'); var cardTejido = document.getElementById('cardTejido');
  function renderGrado(mode){ if(!gradoOptions) return; var html=''; gradoOptions.classList.remove('munich');
    if(mode==='munich'){
      html += '\n<label><input type="radio" name="grado" value="Lesi√≥n parcial menor (3A)"> Lesi√≥n parcial menor (3A)</label>';
      html += '\n<label><input type="radio" name="grado" value="Lesi√≥n parcial moderada (3B)"> Lesi√≥n parcial moderada (3B)</label>';
      html += '\n<label><input type="radio" name="grado" value="Lesi√≥n muscular subtotal o total (4)"> Lesi√≥n muscular subtotal o total (4)</label>';
      html += '\n<label><input type="radio" name="grado" value="Lesi√≥n total del tend√≥n / Avulsi√≥n (4)"> Lesi√≥n total del tend√≥n / Avulsi√≥n (4)</label>';
      gradoOptions.innerHTML=html; cardTejido.style.display='none'; gradoOptions.classList.add('munich');
    } else if(mode==='clasica'){
      html += '\n<label><input type="radio" name="grado" value="Grado I"> Grado I</label>';
      html += '\n<label><input type="radio" name="grado" value="Grado II"> Grado II</label>';
      html += '\n<label><input type="radio" name="grado" value="Grado III"> Grado III</label>';
      gradoOptions.innerHTML=html; cardTejido.style.display='none';
    } else {
      html += '\n<label><input type="radio" name="grado" value="Grado 1"> Grado 1</label>';
      html += '\n<label><input type="radio" name="grado" value="Grado 2"> Grado 2</label>';
      html += '\n<label><input type="radio" name="grado" value="Grado 3"> Grado 3</label>';
      html += '\n<label><input type="radio" name="grado" value="Grado 4"> Grado 4</label>';
      gradoOptions.innerHTML=html; cardTejido.style.display='block';
    } }
  if(gradoMode){ gradoMode.addEventListener('click', function(e){ var b=e.target && e.target.closest ? e.target.closest('button[data-mode]') : null; if(!b) return; Array.prototype.slice.call(gradoMode.querySelectorAll('button')).forEach(function(x){ x.classList.remove('active'); }); b.classList.add('active'); renderGrado(b.getAttribute('data-mode')); }); }

  // ===== TESTS m√≠n. y limpieza =====
  function assert(cond,msg){ if(!cond){ console.error('[TEST FAIL]',msg); return false;} console.log('[TEST OK]',msg); return true; }
  var tests=[ function(){ return assert(!!document.getElementById('tabs'),'Existe barra de tabs'); } ];
  for(var i=0;i<tests.length;i++){ try{ tests[i](); }catch(e){ console.error('[TEST ERROR]', e); } }

  try{
    clearPins(); clearFree(); clearLines(); clearLabels();
    clearSelection(); // evita overlay inicial
  }catch(_){}

  loadSVG(); applyColorChip(); setTool(null); renderGrado('bamic');
})();
</script>
</body>
</html>
